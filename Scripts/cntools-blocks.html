<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Block Collector - Cardano Community managed Documentation for Pool Operators</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Home.html">Getting Started</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture.html">Architecture</a></li><li class="chapter-item expanded "><a href="../Common.html">Common</a></li><li class="chapter-item expanded "><a href="../build-and-run.html">Build and Run</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Build/node-cli.html">Node and CLI</a></li><li class="chapter-item expanded "><a href="../Build/wallet.html">Wallet</a></li><li class="chapter-item expanded "><a href="../Build/rest.html">REST</a></li><li class="chapter-item expanded "><a href="../Build/dbsync.html">DBSync tool</a></li><li class="chapter-item expanded "><a href="../Build/graphql.html">GraphQL</a></li></ol></li><li class="chapter-item expanded "><a href="../Setup-Node.html">Set up node as pool operator</a></li><li class="chapter-item expanded "><a href="../cli-scripts.html">Useful Scripts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Scripts/cntools.html">CNTools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Scripts/cntools-changelog.html">Changelog</a></li><li class="chapter-item "><a href="../Scripts/cntools-common.html">Common tasks</a></li><li class="chapter-item expanded "><a href="../Scripts/cntools-blocks.html" class="active">Block Collector</a></li></ol></li><li class="chapter-item expanded "><a href="../Scripts/createAddr.html">Create Keys/Address</a></li><li class="chapter-item expanded "><a href="../Scripts/sendADA.html">Make Transactions</a></li><li class="chapter-item expanded "><a href="../Scripts/topologyupdater.html">topology Updater</a></li></ol></li><li class="chapter-item expanded "><a href="../Staking/Main.html">Guide to the Staking</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Staking/Keys.html">Keys</a></li><li class="chapter-item expanded "><a href="../Staking/Addresses.html">Addresses</a></li><li class="chapter-item expanded "><a href="../Staking/Certificates.html">Certificates</a></li><li class="chapter-item expanded "><a href="../Staking/StakeHolders.html">StakeHolders</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Staking/Owners.html">Owners</a></li><li class="chapter-item "><a href="../Staking/Operators.html">Operators</a></li><li class="chapter-item "><a href="../Staking/Delegates.html">Delegates</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Home.html">Appendix</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Appendix/monitoring.html">Monitoring using Prometheus and Grafana</a></li><li class="chapter-item expanded "><a href="../Appendix/postgres.html">Sample Postgres Setup</a></li><li class="chapter-item expanded "><a href="../Appendix/Setup-Node-Genesis.html">Set up node as BFT member defined in Genesis</a></li></ol></li><li class="chapter-item expanded "><a href="../Contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Cardano Community managed Documentation for Pool Operators</h1>

                    <div class="right-buttons">
                        
                        <a href="https://github.com/cardano-community/guild-operators/blob/master/docs/Scripts/cntools-blocks.md" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#block-collector" id="block-collector">Block Collector</a></h1>
<p>For the core node(block producer) the <code>cntoolsBlockCollector.sh</code> script can be run to monitor the json log file created by cardano-node for traces related to leader slots and block creation. Data collected is stored in a json file, one for each epoch. To view the collected data the main CNTools script is used.</p>
<p>This collector does not in any way replace a proper database like db-sync but can be a good lightweight way of keeping track of slots assigned and if blocks were successfully created. It currently does not verify that the block created makes it onto the chain. If possible this will be added at a later stage.</p>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#installation-and-configuration">Installation and Configuration</a></li>
<li><a href="#view-collected-blocks">View Collected Blocks</a></li>
</ul>
<h3><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h3>
<p>It's assumed the <a href="../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> have already been run.</p>
<p>As the block collector relies on the cardano-node log file for block traces the node configuration file has to be set up in a certain way for it to work. The file used comes from <code>CONFIG</code> parameter in <code>env</code> file.</p>
<ul>
<li>setupScribes configured with <code>scKind: FileSK</code> and <code>scFormat: ScJson</code> as well as a file extension of <code>.json</code></li>
<li>Blocks traces enabled. The script is looking for the following block traces in the log file, more block traces might be added in the future.<br />
<code>TraceNodeIsLeader TraceAdoptedBlock TraceForgedInvalidBlock</code></li>
</ul>
<h3><a class="header" href="#installation-and-configuration" id="installation-and-configuration">Installation and Configuration</a></h3>
<p>The script is best run as a background process. This can be accomplished in many ways but the preferred method is to run it as a  systemd service. A terminal multiplexer like tmux or screen could also be used but not covered here.</p>
<p>sudo/root access needed to configure systemd.</p>
<p>In this example normal output from the <code>cntoolsBlockCollector.sh</code> script is ignored. Error output is logged using syslog and end up in the systems standard syslog file, normally <code>/var/log/syslog</code>. Other logging configurations are not covered here. </p>
<p><strong>1. Create systemd service file</strong><br />
Replace <code>$USER</code> with the correct user for your system. Copy &amp; paste all code below to create the service file.</p>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt;EOF &gt; /etc/systemd/system/cntools-blockcollector.service
[Unit]
Description=CNTools - Block Collector
After=network.target

[Service]
Type=simple
Restart=on-failure
RestartSec=10
User=$USER
WorkingDirectory=/opt/cardano/cnode/scripts
ExecStart=/opt/cardano/cnode/scripts/cntoolsBlockCollector.sh
SuccessExitStatus=143
StandardOutput=null
StandardError=syslog
SyslogIdentifier=cntools-blockcollector

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<p><strong>2. Reload systemd</strong></p>
<pre><code>sudo systemctl daemon-reload
</code></pre>
<p><strong>3. Start block collector</strong><br />
Run below commands to enable automatic start of service on startup and start it.</p>
<pre><code>sudo systemctl enable cntools-blockcollector.service
sudo systemctl start cntools-blockcollector.service
</code></pre>
<h3><a class="header" href="#view-collected-blocks" id="view-collected-blocks">View Collected Blocks</a></h3>
<p>Start CNTools and choose <code>Blocks [b]</code> to open the block viewer.<br />
Either select <code>Epoch</code> and enter the epoch you want to see a detailed view for or choose <code>Summary</code> to display leader slots, adopted blocks and invalid blocks for last x epochs.</p>
<p>If the node was elected to create blocks in the selected epoch it could look something like this:</p>
<p><strong>Summary</strong></p>
<pre><code>+--------+---------------+-----------------+-----------------+
| Epoch  | Leader Slots  | Adopted Blocks  | Invalid Blocks  |
+--------+---------------+-----------------+-----------------+
| 92     | 21            | 21              | 0               |
| 91     | 30            | 30              | 0               |
| 90     | 36            | 36              | 0               |
| 89     | 37            | 37              | 0               |
| 88     | 26            | 26              | 0               |
| 87     | 25            | 25              | 0               |
| 86     | 25            | 25              | 0               |
| 85     | 37            | 37              | 0               |
| 84     | 30            | 30              | 0               |
| 83     | 26            | 26              | 0               |
+--------+---------------+-----------------+-----------------+
</code></pre>
<p><strong>Epoch</strong></p>
<pre><code>Leader: 5  -  Adopted: 5  -  Invalid: 0

+---------+--------------------------+-------+-------------------------------------------------------------------+
| Slot    | At                       | Size  | Hash                                                              |
+---------+--------------------------+-------+-------------------------------------------------------------------+
| 165619  | 2020-07-11 00:21:19 UTC  | 3     | d1b86acb88e3255ec400354629aa65e5be24c6561a5cbc3f3a04cdc3b1e2a8d1  |
| 165683  | 2020-07-11 00:22:23 UTC  | 3     | 2ce005b1fed86a877aaa58a40f730fcfb3d4876d4218d5ee5e790d89fafd7610  |
| 165696  | 2020-07-11 00:22:36 UTC  | 3     | 0678cb8e04021183f221df6f0ff73f9f9dc39a000c6163bd134d4ae86e9364b5  |
| 165786  | 2020-07-11 00:24:06 UTC  | 3     | 51dfad492f5384230d7b21ec1fee212bd07d79121b2494200fb8f836354ee2f3  |
| 165846  | 2020-07-11 00:25:06 UTC  | 3     | 25e02a42441e83602cc0119c18a6c19f4631fcff22393a3380cbd58d677e3e83  |
+---------+--------------------------+-------+-------------------------------------------------------------------+
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../Scripts/cntools-common.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../Scripts/createAddr.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../Scripts/cntools-common.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../Scripts/createAddr.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
