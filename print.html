<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cardano Community managed Documentation for Pool Operators</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Home.html">Getting Started</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="architecture.html">Architecture</a></li><li class="chapter-item expanded "><a href="Common.html">Common</a></li><li class="chapter-item expanded "><a href="build-and-run.html">Build and Run</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Build/node-cli.html">Node and CLI</a></li><li class="chapter-item expanded "><a href="Build/wallet.html">Wallet</a></li><li class="chapter-item expanded "><a href="Build/rest.html">REST</a></li><li class="chapter-item expanded "><a href="Build/dbsync.html">DBSync tool</a></li><li class="chapter-item expanded "><a href="Build/graphql.html">GraphQL</a></li></ol></li><li class="chapter-item expanded "><a href="Setup-Node.html">Set up node as pool operator</a></li><li class="chapter-item expanded "><a href="cli-scripts.html">Useful Scripts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Scripts/cntools.html">CNTools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Scripts/cntools-common.html">Common tasks</a></li><li class="chapter-item "><a href="Scripts/cntools-blocks.html">Block Collector</a></li></ol></li><li class="chapter-item expanded "><a href="Scripts/createAddr.html">Create Keys/Address</a></li><li class="chapter-item expanded "><a href="Scripts/sendADA.html">Make Transactions</a></li><li class="chapter-item expanded "><a href="Scripts/topologyupdater.html">topology Updater</a></li></ol></li><li class="chapter-item expanded "><a href="Staking/Main.html">Guide to the Staking</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Staking/Keys.html">Keys</a></li><li class="chapter-item expanded "><a href="Staking/Addresses.html">Addresses</a></li><li class="chapter-item expanded "><a href="Staking/Certificates.html">Certificates</a></li><li class="chapter-item expanded "><a href="Staking/StakeHolders.html">StakeHolders</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Staking/Owners.html">Owners</a></li><li class="chapter-item "><a href="Staking/Operators.html">Operators</a></li><li class="chapter-item "><a href="Staking/Delegates.html">Delegates</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="Home.html">Appendix</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Appendix/monitoring.html">Monitoring using Prometheus and Grafana</a></li><li class="chapter-item expanded "><a href="Appendix/postgres.html">Sample Postgres Setup</a></li><li class="chapter-item expanded "><a href="Appendix/Setup-Node-Genesis.html">Set up node as BFT member defined in Genesis</a></li></ol></li><li class="chapter-item expanded "><a href="Contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Cardano Community managed Documentation for Pool Operators</h1>

                    <div class="right-buttons">
                        
                        <a href="https://github.com/cardano-community/guild-operators/blob/master/docs/print.md" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3><a class="header" href="#welcome" id="welcome">Welcome!!</a></h3>
<p>This documentation (rather the repository itself) is created by some of the community members and serves as an easy means to add documentation or scripts that make more sense to users. The target audience for this document are mainly experienced stake pool operators.</p>
<p>The repository is already open to collaboration from many members within community. We would love community contributions and verification of the instructions, rather than having 100 versions of documentation. If there are any discrepancies/suggestions/contributions for this document, please open an Issue and one of the collaborators should be able to add the changes in.</p>
<h4><a class="header" href="#getting-started-with-haskell-node" id="getting-started-with-haskell-node">Getting Started with Haskell Node</a></h4>
<p>Use the sidebar to navigate through the topics. Note that the instructions assume the folder structure as per the Next topic. You're expected to update the folder reference as per your environment.
Also, since you cannot run a Praos node yet, the instructions here-in allow you to join a private haskell testnet network (phtn).  We will gradually update to Praos version and update the phtn references.</p>
<p>*Note that the shelley (Praos) codebase is still being cooked in the oven while we're trying to taste it, expect hand burns if not careful
Since we're just trying to keep up with codebase, expect rapid changes (some breaking, requiring redo of network - but that's always the intent of keeping up with bleeding tech). Feedback/Contribution and ownership of tasks is always welcome.</p>
<h3><a class="header" href="#architecture" id="architecture">Architecture</a></h3>
<p>The architecture and description of various components are best described at <a href="https://input-output-hk.github.io/adrestia/docs/architecture/">Adrestia User Guide</a> by IOHK, which you can also view below.</p>
<div>
<iframe src="https://input-output-hk.github.io/adrestia/docs/architecture/" frameborder="0" class="adrestia-arch"></iframe></div>
<h3><a class="header" href="#pre-requisites" id="pre-requisites">Pre-Requisites</a></h3>
<h4><a class="header" href="#dependencies-and-folder-structure-setup" id="dependencies-and-folder-structure-setup">Dependencies and Folder Structure setup</a></h4>
<p>The pre-requisites for Linux systems are automated to be executed as a single script. Note that the guide assumes you do <em>NOT</em> change working directory or mix multiple SSH sessions.
Please ensure to <em>READ</em> the output if you execute something and investigate/raise issue if you receive an error. Do not continue bypassing any errors.
Follow the instructions below to deploy the same:</p>
<pre><code class="language-bash">mkdir &quot;$HOME/tmp&quot;;cd &quot;$HOME/tmp&quot;
# Install wget
# CentOS / RedHat - sudo dnf -y install wget
# Ubuntu / Debian - sudo apt -y install wget
wget https://raw.githubusercontent.com/cardano-community/guild-operators/master/files/ptn0/scripts/prereqs.sh
chmod 755 prereqs.sh
# Ensure you can run sudo commands with your user before execution
./prereqs.sh
## Follow the prompts for execution. To make sure environment variables are available for session you're running, make sure to source bashrc
. &quot;${HOME}/.bashrc&quot;
</code></pre>
<h4><a class="header" href="#connect-to-public-haskell-testnet-network-htn" id="connect-to-public-haskell-testnet-network-htn">Connect to public Haskell Testnet Network (HTN)</a></h4>
<p>The prereqs script above will connect you to guild network. If you would like to connect to public HTN instead, kindly execute the below before you proceed after you've executed the above:</p>
<pre><code class="language-bash">wget -O $CNODE_HOME/files/topology.json https://hydra.iohk.io/job/Cardano/cardano-node/cardano-deployment/latest-finished/download/1/shelley_testnet-topology.json
wget -O $CNODE_HOME/files/genesis.json https://hydra.iohk.io/job/Cardano/cardano-node/cardano-deployment/latest-finished/download/1/shelley_testnet-genesis.json
</code></pre>
<p>If you were already running a node on guild network and would like to <em>replace</em> by moving to HTN, but continue using scripts - follow instructions below:</p>
<ul>
<li>Stop your node (if running).</li>
<li>Ensure you've run commands above which will place updated files at correct location.</li>
<li>Delete your existing DB folder by executing <code>rm -rf $CNODE_HOME/db/*</code> (or alternately - you can rename the folder to switch back later).</li>
<li>Start the node</li>
</ul>
<p>Eventually, you should be able to maintain different versions by tweaking scripts as desired. But for simplicity and reducing manual interventions, we will keep the guide using uniform paths.</p>
<h4><a class="header" href="#folder-structure" id="folder-structure">Folder structure</a></h4>
<p>Running the script above will create the folder structure as per below, for your reference.</p>
<pre><code>/opt/cardano/cnode          # Top-Level Folder
├── ...
├── files                   # Config, genesis and topology files
│   ├── ...
│   ├── genesis.json        # Genesis file referenced in ptn0.yaml
│   ├── ptn0.yaml           # Config file used by cardano-node
│   └── topology.json       # Map of chain for cardano-node to boot from
├── db                      # DB Store for cardano-node
├── logs                    # Logs for cardano-node
├── priv                    # Folder to store your keys (permission: 600)
├── scripts                 # Scripts to start and interact with cardano-node
├── sockets                 # Socket files created by cardano-node
└── ...
</code></pre>
<h3><a class="header" href="#build-and-run" id="build-and-run">Build and Run</a></h3>
<p>This document is built using instructions from <a href="https://github.com/input-output-hk">IOHK repositories</a> as a foundation, with additional info/clarification which we can contribute to where appropriate. Note that not everyone needs to build each component. You can refer to <a href="./architecture.html">architecture</a> to understand and qualify which components you want to run. For most Pool Operators, simply building <a href="./Build/node-cli.html">cardano-node</a> might be enough.</p>
<p><strong>The instructions are intentionally limited to cabal</strong> to avoid wait times/availability of nix/docker/stack.yaml files on, what we expect to be, a rapidly developing codebase - this will also help prevent managing multiple versions of instructions (at least for now).</p>
<p>Note that the instructions are predominantly focused around building Cardano components and OS/3rd-party software (eg: postgres) setup instructions are intended to provide build-level information only.</p>
<p>Of course, we can always add links with specific best practices related to those instructions - for those who would like to contribute, please open a PR directly on the <a href="https://github.com/cardano-community/guild-operators/tree/master/docs">github repo</a> to do so.</p>
<h4><a class="header" href="#docker-builds" id="docker-builds">Docker Builds:</a></h4>
<p>If you would like to go down the Docker route, the basic instructions to get you set up with Docker itself are below. Additionally, you can follow <a href="https://input-output-hk.github.io/adrestia/docs/installation/">IOHK Adrestia documentation</a> for the latest release information:</p>
<pre><code class="language-bash"># CentOS
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm
sudo yum install -y docker-ce docker-ce-cli
sudo systemctl enable docker
sudo chkconfig docker on

## These steps would be automatically performed by the install above
# sudo groupadd docker
# sudo usermod -aG docker $USER
sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.5/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/bin/docker-compose;chmod 755 /usr/bin/docker-compose
</code></pre>
<h3><a class="header" href="#cardano-node-and-cardano-cli" id="cardano-node-and-cardano-cli">Cardano Node and Cardano CLI</a></h3>
<p>Ensure the <a href="Build/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#build-instructions" id="build-instructions">Build Instructions</a></h4>
<p>Run the commands below to clone the Cardano Node git repository and build the binaries:</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/input-output-hk/cardano-node
cd cardano-node
### Please ensure you have run the *UPDATED* prereqs.sh (see link at top of this document) before continuing
echo -e &quot;package cardano-crypto-praos\n  flags: -external-libsodium-vrf&quot; &gt; cabal.project.local
$CNODE_HOME/scripts/cabal-build-all.sh
</code></pre>
<p>The above would copy the binaries built into ~/.cabal/bin folder.</p>
<h4><a class="header" href="#verify" id="verify">Verify</a></h4>
<p>Execute cardano-cli and cardano-node to verify output as below:</p>
<pre><code class="language-bash">cardano-cli version
# cardano-cli 1.11.0 - linux-x86_64 - ghc-8.6
cardano-node
#Usage: cardano-node (run | run-mock) [--help]
#  Start node of the Cardano blockchain.
#
#Available options:
#  --help                   Show this help text
#
#Execute node with a real protocol.
#  run                      Execute node with a real protocol.
#
#Execute node with a mock protocol.
#  run-mock                 Execute node with a mock protocol.
</code></pre>
<h3><a class="header" href="#cardano-wallet" id="cardano-wallet">Cardano Wallet</a></h3>
<p><strong>Note: Cardano Wallet does not support TPraos network yet (it does support BFT networks and ITN Praos) - but as soon as it does, instructions below should still remain valid</strong></p>
<p>Ensure the <a href="Build/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#build-instructions-1" id="build-instructions-1">Build Instructions</a></h4>
<p>Follow instructions below for building the cardano-wallet binary:</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/input-output-hk/cardano-wallet
cd cardano-wallet

# Note: The cardano-wallet repo does not work yet with cabal, hence alternate for now is using stack to build
# In case you do not have stack installed, you can install it using command below:
#    curl -sSL https://get.haskellstack.org/ | sh
$CNODE_HOME/scripts/stack-build.sh

</code></pre>
<p>The above would copy the binaries into ~/.cabal/bin folder.</p>
<h4><a class="header" href="#start-the-wallet-server" id="start-the-wallet-server">Start the wallet server</a></h4>
<pre><code class="language-bash">cardano-wallet-byron serve --node-socket $CNODE_HOME/sockets/node0.socket --testnet $CNODE_HOME/files/genesis.json --database $CNODE_HOME/priv/wallet
</code></pre>
<h4><a class="header" href="#verify-the-wallet-is-handling-requests" id="verify-the-wallet-is-handling-requests">Verify the wallet is handling requests</a></h4>
<pre><code class="language-bash">cardano-wallet-byron network information
</code></pre>
<p>Expected output should be similar to the following</p>
<pre><code class="language-json">Ok.
{
    &quot;network_tip&quot;: {
        &quot;epoch_number&quot;: 4,
        &quot;slot_number&quot;: 730
    },
    &quot;node_tip&quot;: {
        &quot;height&quot;: {
            &quot;quantity&quot;: 2390,
            &quot;unit&quot;: &quot;block&quot;
        },
        &quot;epoch_number&quot;: 4,
        &quot;slot_number&quot;: 728
    },
    &quot;sync_progress&quot;: {
        &quot;status&quot;: &quot;ready&quot;
    },
    &quot;next_epoch&quot;: {
        &quot;epoch_start_time&quot;: &quot;2020-04-27T09:48:35Z&quot;,
        &quot;epoch_number&quot;: 5
    }
}
</code></pre>
<h4><a class="header" href="#create-a-new-wallet" id="create-a-new-wallet">Create a new wallet</a></h4>
<h5><a class="header" href="#first-generate-a-mnemonic-phrase" id="first-generate-a-mnemonic-phrase">First generate a mnemonic phrase</a></h5>
<pre><code class="language-bash">cardano-wallet-byron mnemonic generate
# false brother typical saddle settle phrase foster sauce ask sunset firm gate service render burger
</code></pre>
<h5><a class="header" href="#generate-a-new-byron-wallet-from-your-mnemonic-phrase" id="generate-a-new-byron-wallet-from-your-mnemonic-phrase">Generate a new byron wallet from your mnemonic phrase</a></h5>
<pre><code class="language-bash">cardano-wallet-byron wallet create from-mnemonic --wallet-style icarus &quot;Guild Test Wallet&quot;
</code></pre>
<h5><a class="header" href="#expected-output" id="expected-output">Expected output:</a></h5>
<pre><code class="language-text">Please enter 15 mnemonic words : false brother typical saddle settle phrase foster sauce ask sunset firm gate service render burger
Please enter a passphrase: ******************
Enter the passphrase a second time: ******************
Ok.
{
    &quot;passphrase&quot;: {
        &quot;last_updated_at&quot;: &quot;2020-04-27T06:35:19.48354187Z&quot;
    },
    &quot;state&quot;: {
        &quot;status&quot;: &quot;syncing&quot;,
        &quot;progress&quot;: {
            &quot;quantity&quot;: 0,
            &quot;unit&quot;: &quot;percent&quot;
        }
    },
    &quot;discovery&quot;: &quot;sequential&quot;,
    &quot;balance&quot;: {
        &quot;total&quot;: {
            &quot;quantity&quot;: 0,
            &quot;unit&quot;: &quot;lovelace&quot;
        },
        &quot;available&quot;: {
            &quot;quantity&quot;: 0,
            &quot;unit&quot;: &quot;lovelace&quot;
        }
    },
    &quot;name&quot;: &quot;Guild Test Wallet&quot;,
    &quot;id&quot;: &quot;0854da56dd00ae2099a499303681826506527ac7&quot;,
    &quot;tip&quot;: {
        &quot;height&quot;: {
            &quot;quantity&quot;: 0,
            &quot;unit&quot;: &quot;block&quot;
        },
        &quot;epoch_number&quot;: 0,
        &quot;slot_number&quot;: 0
    }
}
</code></pre>
<h3><a class="header" href="#cardano-rest" id="cardano-rest">Cardano Rest</a></h3>
<p>Ensure the <a href="Build/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#build-instructions-2" id="build-instructions-2">Build Instructions</a></h4>
<p>Clone the cardano-rest repository from github</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/input-output-hk/cardano-rest.git
cd cardano-rest
$CNODE_HOME/scripts/cabal-build-all.sh
</code></pre>
<p>The above would copy the binaries into ~/.cabal/bin folder.</p>
<h4><a class="header" href="#start-the-rest-server" id="start-the-rest-server">Start the REST server</a></h4>
<p>Execute the below to start the Cardano Explorer API Server:</p>
<pre><code class="language-bash">export PGPASSFILE=$CNODE_HOME/priv/.pgpass
cardano-explorer-api
# Running full server on http://localhost:8100/
</code></pre>
<h4><a class="header" href="#verify-the-rest-server-is-functioning" id="verify-the-rest-server-is-functioning">Verify the REST server is functioning</a></h4>
<p>Verify that you can query the API Server using instruction below:</p>
<pre><code class="language-bash">curl http://localhost:8100/api/blocks/pages
</code></pre>
<p>Expected output should be similar to the following:</p>
<pre><code class="language-json">{&quot;Right&quot;:[261,[{&quot;cbeEpoch&quot;:4,&quot;cbeSlot&quot;:9345,&quot;cbeBlkHeight&quot;:2605,&quot;cbeBlkHash&quot;:&quot;9026612cfa53b7f8a84ff62c4e897830db9ab6ce24b19e0059f4b4db7a14c0f9&quot;,&quot;cbeTimeIssued&quot;:1587974365,&quot;cbeTxNum&quot;:0,&quot;cbeTotalSent&quot;:{&quot;getCoin&quot;:&quot;0&quot;},&quot;cbeSize&quot;:631,&quot;cbeBlockLead&quot;:&quot;464835a0904109be93d7996b9b4acc486f6c8f75a595b2c4392f9521&quot;,&quot;cbeFees&quot;:{&quot;getCoin&quot;:&quot;0&quot;}},{&quot;cbeEpoch&quot;:4,&quot;cbeSlot&quot;:9341,&quot;cbeBlkHeight&quot;:2604,&quot;cbeBlkHash&quot;:&quot;24000e2986bbfbfd610cb105d3697cce7582b8570469c4ff944b91d7dd0dc58f&quot;,&quot;cbeTimeIssued&quot;:1587974325,&quot;cbeTxNum&quot;:0,&quot;cbeTotalSent&quot;:{&quot;getCoin&quot;:&quot;0&quot;},&quot;cbeSize&quot;:631,&quot;cbeBlockLead&quot;:&quot;1ce88674d08d7813c5281e38e8a43b51550292f0bd8907b17a62eef2&quot;,&quot;cbeFees&quot;:{&quot;getCoin&quot;:&quot;0&quot;}},{&quot;cbeEpoch&quot;:4,&quot;cbeSlot&quot;:9338,&quot;cbeBlkHeight&quot;:2603,&quot;cbeBlkHash&quot;:&quot;5c2737421b223d1ab67f1046f8841d57d7f8456b77a841702fbb18bccf71a216&quot;,&quot;cbeTimeIssued&quot;:1587974295,&quot;cbeTxNum&quot;:0,&quot;cbeTotalSent&quot;:{&quot;getCoin&quot;:&quot;0&quot;},&quot;cbeSize&quot;:631,&quot;cbeBlockLead&quot;:&quot;f6a4cfa43cef5ebed8fbd0527153f9896d1f9dd83bd1d55e609d622b&quot;,&quot;cbeFees&quot;:{&quot;getCoin&quot;:&quot;0&quot;}},{&quot;cbeEpoch&quot;:4,&quot;cbeSlot&quot;:9333,&quot;cbeBlkHeight&quot;:2602,&quot;cbeBlkHash&quot;:&quot;496db1bc19d609687185e394cfcb8fa15e8df652c7dc40a58a347e30b9e4a25f&quot;,&quot;cbeTimeIssued&quot;:1587974245,&quot;cbeTxNum&quot;:0,&quot;cbeTotalSent&quot;:{&quot;getCoin&quot;:&quot;0&quot;},&quot;cbeSize&quot;:631,&quot;cbeBlockLead&quot;:&quot;a7cad2c48edecff1627bac50aab5fcc6831f6ab91131721269850805&quot;,&quot;cbeFees&quot;:{&quot;getCoin&quot;:&quot;0&quot;}},{&quot;cbeEpoch&quot;:4,&quot;cbeSlot&quot;:9332,&quot;cbeBlkHeight&quot;:2601,&quot;cbeBlkHash&quot;:&quot;8a837d43685dd350c6f1773b1ede7843d56d093a425ff4ccd799f7ff1b76204d&quot;,&quot;cbeTimeIssued&quot;:1587974235,&quot;cbeTxNum&quot;:0,&quot;cbeTotalSent&quot;:{&quot;getCoin&quot;:&quot;0&quot;},&quot;cbeSize&quot;:631,&quot;cbeBlockLead&quot;:&quot;a18aa0130f67053ed1cb346813054e160687a8ee7602a549f8ae165b&quot;,&quot;cbeFees&quot;:{&quot;getCoin&quot;:&quot;0&quot;}}]]}
</code></pre>
<h3><a class="header" href="#dbsync-tool" id="dbsync-tool">DBSync tool</a></h3>
<p>Cardano DB Sync tool relies on an existing PostgreSQL server. To keep the focus on building dbsync tool, and not how to setup postgres itself, you can refer to <a href="Build/../Appendix/postgres.html">Sample Local PostgreSQL Server Deployment instructions</a> for setting up Postgres instance.</p>
<p>Ensure the <a href="Build/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#build-cardano-db-sync" id="build-cardano-db-sync">Build cardano-db-sync</a></h4>
<p>To build instructions for cardano-db-sync tool will be similar to cardano-node:</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/input-output-hk/cardano-db-sync
cd cardano-db-sync
$CNODE_HOME/scripts/cabal-build-all.sh
</code></pre>
<p>Similar to before, <code>cardano-db-sync</code> and <code>cardano-db-sync-extended</code> should now be available in ~/.cabal/bin folder.</p>
<h4><a class="header" href="#prepare-db-for-cardano-db-sync-" id="prepare-db-for-cardano-db-sync-">Prepare DB for cardano-db-sync :</a></h4>
<pre><code class="language-bash">cd ~/git/cardano-db-sync
# scripts/postgresql-setup.sh --dropdb #if exists already, will fail if it doesnt - thats OK
scripts/postgresql-setup.sh --createdb
# Password:
# Password:
# All good!
## Verify you can see &quot;All good!&quot; as above
</code></pre>
<h4><a class="header" href="#start-cardano-db-sync-tool" id="start-cardano-db-sync-tool">Start cardano-db-sync-tool</a></h4>
<pre><code class="language-bash">cd ~/git/cardano-db-sync
PGPASSFILE=$CNODE_HOME/priv/.pgpass cardano-db-sync-extended --config $CNODE_HOME/files/ptn0.yaml --genesis-file $CNODE_HOME/files/genesis.json --socket-path $CNODE_HOME/sockets/node0.socket --schema-dir schema/
</code></pre>
<p>You can use same instructions above to repeat and execute <code>cardano-db-sync</code> as well, but <a href="Build/./graphql.html">cardano-graphql</a> uses <code>cardano-db-sync-extended</code>, so we'll stick to it</p>
<h4><a class="header" href="#validation" id="validation">Validation</a></h4>
<p>To validate, connect to postgres instance and execute commands as per below:</p>
<pre><code class="language-bash">export PGPASSFILE=$CNODE_HOME/priv/.pgpass
psql cexplorer_phtn
</code></pre>
<p>You should be at the psql prompt, you can check the tables and verify they're populated:</p>
<pre><code class="language-sql">\dt
#            List of relations
# Schema |      Name      | Type  | Owner
#--------+----------------+-------+-------
# public | block          | table | &lt;username&gt;
# public | epoch          | table | &lt;username&gt;
# public | meta           | table | &lt;username&gt;
# public | schema_version | table | &lt;username&gt;
# public | slot_leader    | table | &lt;username&gt;
# public | tx             | table | &lt;username&gt;
# public | tx_in          | table | &lt;username&gt;
# public | tx_out         | table | &lt;username&gt;
#(8 rows)

select * from meta;
# id | protocol_const | slot_duration |     start_time      | network_name
#----+----------------+---------------+---------------------+--------------
#  1 |          43200 |         20000 | 2020-04-12 13:55:37 | pHTN
#(1 row)

select * from tx;
# id |                                hash                                | block | fee |     out_sum      | size
#----+--------------------------------------------------------------------+-------+-----+------------------+------
#  1 | \x26b63ce785b16fc53ba3ab882ac0e5342a77b33f355ba82982e3e2d5e05500df |     1 |   0 |       1000000000 |    0
#  2 | \xbd8f661658dabbb557d4b5e23264d34fda2a2304daccdac283e337581a88c479 |     1 |   0 |   62499975000000 |    0
#  3 | \x17fbf571b7d091e9cfb6853cd5fb603031831ce7e5e3acbb4b842960e90ba419 |     1 |   0 |   62499975000000 |    0
#  4 | \x3e7e3c1105d3bd76a2b5ae897e1b79b86c7834e68409e533afc318112405ff69 |     1 |   0 |   62499975000000 |    0
# ...
# (36 rows)
</code></pre>
<h3><a class="header" href="#graphql" id="graphql">GraphQL</a></h3>
<p>Ensure the <a href="Build/Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#build-hasura-graphql-engine" id="build-hasura-graphql-engine">Build Hasura graphql-engine</a></h4>
<p>Going with the spirit of the documentation here, instruction to build the graphql-engine binary :)</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/hasura/graphql-engine
cd graphql-engine/server
$CNODE_HOME/scripts/cabal-build-all.sh
</code></pre>
<p>This should make <code>graphql-engine</code> available at ~/.cabal/bin.</p>
<h4><a class="header" href="#build-cardano-graphql" id="build-cardano-graphql">Build cardano-graphql</a></h4>
<p>The build will fail if you are running a version of node.js earlier than 10.0.0 (which could happen if you have a conflicting version in your $PATH). You can verify your node version by executing the below:</p>
<pre><code class="language-bash">#check your version of node.js
node -v
#if response is 10.0.0 or higher build can proceed. 
</code></pre>
<p>The commands below will help you compile the cardano-graphql node:</p>
<pre><code class="language-bash">cd ~/git
git clone https://github.com/input-output-hk/cardano-graphql
cd cardano-graphql
git checkout v1.1.1
yarn
#yarn install v1.22.4
# [1/4] Resolving packages...
# [2/4] Fetching packages...
# info fsevents@2.1.2: The platform &quot;linux&quot; is incompatible with this module.
# info &quot;fsevents@2.1.2&quot; is an optional dependency and failed compatibility check. Excluding it from installation.
# info fsevents@1.2.12: The platform &quot;linux&quot; is incompatible with this module.
# info &quot;fsevents@1.2.12&quot; is an optional dependency and failed compatibility check. Excluding it from installation.
# [3/4] Linking dependencies...
# warning &quot; &gt; graphql-type-datetime@0.2.4&quot; has incorrect peer dependency &quot;graphql@^0.13.2&quot;.
# warning &quot; &gt; @typescript-eslint/eslint-plugin@1.13.0&quot; has incorrect peer dependency &quot;eslint@^5.0.0&quot;.
# warning &quot; &gt; @typescript-eslint/parser@1.13.0&quot; has incorrect peer dependency &quot;eslint@^5.0.0&quot;.
# [4/4] Building fresh packages...
# Done in 20.70s.
yarn build
# yarn run v1.22.4
# $ yarn codegen:internal &amp;&amp; yarn codegen:external &amp;&amp; tsc -p . &amp;&amp; shx cp src/schema.graphql dist/
# $ graphql-codegen
#   ✔ Parse configuration
#   ✔ Generate outputs
# $ graphql-codegen --config ./codegen.external.yml
#   ✔ Parse configuration
#   ✔ Generate outputs
# Done in 38.11s.
cd dist
rsync -arvh ../node_modules ./
</code></pre>
<h4><a class="header" href="#set-up-environment-for-cardano-graphql" id="set-up-environment-for-cardano-graphql">Set up environment for cardano-graphql</a></h4>
<p>cardano-graphql requires cardano-node, cardano-db-sync-extended, postgresql and graphql-engine to be set up and running.
The below will help you map the components:</p>
<pre><code class="language-bash">export PGPASSFILE=$CNODE_HOME/priv/.pgpass
IFS=':' read -r -a PGPASS &lt;&lt;&lt; $(cat $PGPASSFILE)
export HASURA_GRAPHQL_ENABLE_TELEMETRY=false  # Optional.  To send usage data to Hasura, set to true.
export HASURA_GRAPHQL_DATABASE_URL=postgres://${PGPASS[3]}:${PGPASS[4]}@${PGPASS[0]}:${PGPASS[1]}/${PGPASS[2]}
export HASURA_GRAPHQL_ENABLE_CONSOLE=true
export HASURA_GRAPHQL_ENABLED_LOG_TYPES=&quot;startup, http-log, webhook-log, websocket-log, query-log&quot;
export HASURA_GRAPHQL_SERVER_PORT=4080
export HASURA_GRAPHQL_SERVER_HOST=0.0.0.0
export CACHE_ENABLED=true
export HASURA_URI=http://127.0.0.1:4080
cd ~/git/cardano-graphql/dist
graphql-engine serve &amp;
node index.js
</code></pre>
<p>Note that if you do not want your node to be publicly available, you can change <code>--host-addr</code> to <code>127.0.0.1</code></p>
<h3><a class="header" href="#run-a-passive-node" id="run-a-passive-node">Run a passive node</a></h3>
<p>This document helps you to set a basic Passive Node connecting to the network. This would also be a first step if you do not have a genesis (BFT) keys for TPraos network, to allow you to register your pool.
Ensure the <a href="Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<p>To start the node in passive mode, execute the steps as below:</p>
<h4><a class="header" href="#start-passive-node" id="start-passive-node">Start Passive Node</a></h4>
<p>To start the node in passive mode, execute the steps as below:</p>
<pre><code class="language-bash">cardano-node run \
          --config $CNODE_HOME/files/ptn0.yaml \
          --database-path $CNODE_HOME/db \
          --host-addr 0.0.0.0 \
          --port 5001 \
          --socket-path $CNODE_HOME/sockets/node0.socket \
          --topology $CNODE_HOME/files/topology.json
</code></pre>
<h4><a class="header" href="#start-as-pool-operator" id="start-as-pool-operator">Start as Pool Operator</a></h4>
<p>To start the node as a block producing pool, execute the steps as below:</p>
<pre><code class="language-bash"># TODO: Add reference to key creations.
# POOLNAME=POOL123
POOLKEYSPATH=$CNODE_HOME/priv/pool/$POOLNAME
cardano-node run \
          --config $CNODE_HOME/files/ptn0.yaml \
          --database-path $CNODE_HOME/db \
          --host-addr 0.0.0.0 \
          --port 5001 \
          --socket-path $CNODE_HOME/sockets/node0.socket \
          --topology $CNODE_HOME/files/topology.json \
          --shelley-kes-key $CNODE_HOME/priv/pool/$POOLNAME/hot.skey \
          --shelley-vrf-key $CNODE_HOME/priv/pool/$POOLNAME/vrf.skey \
          --shelley-operational-certificate $CNODE_HOME/priv/pool/$POOLNAME/op.cert
</code></pre>
<p>Note that if you do not want your node to be publicly available, you can change <code>--host-addr</code> to <code>127.0.0.1</code>
If this is your relay node, you can update topology.json to link to your core node.</p>
<h3><a class="header" href="#collection-of-value-added-scripts" id="collection-of-value-added-scripts">Collection of Value-added scripts</a></h3>
<p>A place to collect scripts that are supposed to help with usage of Cardano-node. The attempt with these scripts is to keep things similar to the popular jormungandr scripts that pool operators in ITN have been accustomed to. Use the navigation menu on the left to drill down to specific script.</p>
<h1><a class="header" href="#cntools" id="cntools">CNTools</a></h1>
<p>CNTools is a shell script that will simplify typical operations for wallets and pool management. The tool is developed against the latest master branch of <a href="https://github.com/input-output-hk/cardano-node">cardano-node</a> and as such may contain breaking changes not compatible with all testnet networks running against a specific tag. As the code matures these breaking changes should be less frequent. Please note that this tool is tested on Linux platforms only at this point.</p>
<p>The script assumes the <a href="Scripts/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> have already been run.</p>
<ul>
<li><a href="Scripts/cntools.html#overview">Overview</a></li>
<li><a href="Scripts/cntools.html#download-and-update">Download and Update</a></li>
<li><a href="Scripts/cntools.html#start">Start CNTools</a></li>
<li><a href="Scripts/cntools.html#navigation">Navigation</a></li>
</ul>
<h4><a class="header" href="#overview" id="overview">Overview</a></h4>
<p>The tool consist of four files.</p>
<ul>
<li><strong><code>cntools.sh</code></strong><br />
the main script to launch cntools.</li>
<li><strong><code>cntools.library</code></strong><br />
internal script with helper functions.</li>
<li><strong><code>cntools.config</code></strong><br />
configuration file to modify certain behaviours, paths and name schema used.</li>
<li><strong><code>cntoolsBlockCollector.sh</code></strong><br />
a script to be run in background on core node parsing log file for block traces.<br />
see <a href="Scripts/cntools-blocks.html">Block Collector</a> section for more details.</li>
</ul>
<p>In addition to the above files, there is also a dependency on the common <code>env</code> file. CNTools connects to your node through the configuration in the <code>env</code> file located in the same directory as the script. Customize <code>env</code> and <code>cntools.config</code> files for your needs.  CNTools will start even if your node is offline, but don't expect to get very far.</p>
<h4><a class="header" href="#download-and-update" id="download-and-update">Download and Update</a></h4>
<p>If you have run <code>prereqs.sh</code>, this should already be available in your scripts folder and make this step unnecessary. </p>
<p>To download cntools manually you can execute the commands below:</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts
wget -O cntools.sh https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/cntools.sh
wget -O cntools.config https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/cntools.config
wget -O cntools.library https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/cntools.library
wget -O cntoolsBlockCollector.sh https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/cntoolsBlockCollector.sh
wget -O env https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/env
chmod 750 cntools.sh cntoolsBlockCollector.sh
chmod 640 cntools.config cntools.library env
</code></pre>
<h4><a class="header" href="#start" id="start">Start</a></h4>
<p><code>$ ./cntools.sh</code></p>
<p>You should get a screen that looks something like this:</p>
<pre><code> &gt;&gt; CNTOOLS 0.1 &lt;&lt;                                       A Guild Operators collaboration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Main Menu

 ) Wallet  -  create, show, remove and protect wallets
 ) Funds   -  send, withdraw and delegate
 ) Pool    -  pool creation and management
 ) Blocks  -  show core node leader slots
 ) Update  -  update cntools script and library config files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 What would you like to do?

  [w] Wallet
  [f] Funds
  [p] Pool
  [b] Blocks
  [u] Update
  [q] Quit
</code></pre>
<h4><a class="header" href="#navigation" id="navigation">Navigation</a></h4>
<p>The scripts menu supports both arrow key navigation and shortcut key selection. The character within the square brackets is the shortcut to press for quick navigation. For other selections like wallet and pool menu that doesn't contain shortcuts, there is a third way to navigate. Key pressed is compared to the first character of the menu option and if there is a match selection jumps to this location. A handy way to quickly navigate a large menu. </p>
<h1><a class="header" href="#common-tasks" id="common-tasks">Common tasks</a></h1>
<p>This chapter describes some common tasks for wallet and pool creation.<br />
CNTools contains more functionality not described here. </p>
<p>Step by Step guide to create a pool with CNTools</p>
<ul>
<li><a href="Scripts/cntools-common.html#stake-wallet">Stake Wallet</a><br />
a stake wallet is needed for delegation/pledge</li>
<li><a href="Scripts/cntools-common.html#create-pool">Create Pool</a><br />
create the necessary pool keys </li>
<li><a href="Scripts/cntools-common.html#create-pool">Register Pool</a><br />
register the pool on-chain</li>
</ul>
<h4><a class="header" href="#stake-wallet" id="stake-wallet">Stake Wallet</a></h4>
<p><strong>1.</strong> <code>Choose Wallet [w]</code> and you will be presented with the following menu:</p>
<pre><code> &gt;&gt; WALLET
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Wallet Management

 ) New      -  create a new payment wallet or upgrade existing to a stake wallet
 ) List     -  list all available wallets in a compact view
 ) Show     -  show detailed view of a specific wallet
 ) Remove   -  remove a wallet
 ) Decrypt  -  remove write protection and decrypt wallet
 ) Encrypt  -  encrypt wallet keys and make all files immutable
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Select wallet operation

  [n] New
  [l] List
  [s] Show
  [r] Remove
  [d] Decrypt
  [e] Encrypt
  [h] Home
</code></pre>
<p><strong>2.</strong> Choose <code>New [n]</code> to go to submenu for creating a new wallet</p>
<pre><code> &gt;&gt; WALLET &gt;&gt; NEW
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Wallet Type

 ) Payment  -  First step for a new wallet
               A payment wallet can send and receive funds but not delegate/pledge.

 ) Stake    -  Upgrade existing payment wallet to a stake wallet
               Make sure there are funds available in payment wallet before upgrade
               as this is needed to pay for the stake wallet registration fee.
               A stake wallet is needed to be able to delegate and pledge to a pool.
               All funds from payment address will be moved to base address.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 Choose wallet type

  [p] Payment
  [s] Stake
  [h] Home
</code></pre>
<p><strong>3.</strong> Choose <code>Payment [p]</code> type of wallet<br />
<strong>4.</strong> Give the wallet a name<br />
<strong>5.</strong> CNTools will give you your payment address.  For example:</p>
<pre><code> &gt;&gt; WALLET &gt;&gt; NEW &gt;&gt; PAYMENT
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Name of new wallet: bob

New Wallet: bob
Payment Address: 60f8a4bed2e379cf8ee5aa28bb7b227362b38694368b767b270720760503132fc5
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre>
<p><strong>6.</strong>  Send some money to this wallet. Either through the faucet or have a friend send you some.<br />
<strong>IMPORTANT</strong> - The wallet must have funds in it before you can proceed.<br />
<strong>7.</strong>  From the main menu choose <code>Wallet &gt;&gt; New</code> and then this time choose <code>Stake [s]</code> to upgrade your wallet<br />
<strong>8.</strong>  CNTools will give you a list of wallets you can upgrade. Choose the wallet you created in step 4. In this example case, that wallet is called <code>bob</code>. This will send a transaction to the blockchain to upgrade your wallet to a staking wallet. The result should look something like this:</p>
<pre><code>New block was created - 23386
New Stake Wallet : bob
Payment Address  : 60f8a4bed2e379cf8ee5aa28bb7b227362b38694368b767b270720760503132fc5
Payment Balance  : 0 ADA
Base Address     : 00f8a4bed2e379cf8ee5aa28bb7b227362b38694368b767b270720760503132fc545bdb48005781a47a864347843654fd58c1363695453697b5b59fd7ca2af3dc8
Base Balance     : 99.428691 ADA
Reward Address   : 5821e045bdb48005781a47a864347843654fd58c1363695453697b5b59fd7ca2af3dc8
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre>
<p>The total balance is 0 for the payment address because ALL funds have been moved to the base address.</p>
<h4><a class="header" href="#create-pool" id="create-pool">Create Pool</a></h4>
<p><strong>1.</strong> From the main menu select <code>Pool [p]</code></p>
<pre><code> &gt;&gt; POOL
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Pool Management

 ) New       -  create a new pool
 ) Register  -  register created pool on chain using a stake wallet (pledge wallet)
 ) Modify    -  change pool parameters and register updated pool values on chain
 ) Retire    -  de-register stake pool from chain in specified epoch
 ) List      -  a compact list view of available local pools
 ) Show      -  detailed view of specified pool
 ) Rotate    -  rotate pool KES keys
 ) Decrypt   -  remove write protection and decrypt pool
 ) Encrypt   -  encrypt pool cold keys and make all files immutable
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 Select wallet operation

  [n] New
  [r] Register
  [m] Modify
  [x] Retire
  [l] List
  [s] Show
  [o] Rotate
  [d] Decrypt
  [e] Encrypt
  [h] Home
</code></pre>
<p><strong>2.</strong>  Select <code>New [n]</code> to create a new pool<br />
<strong>3.</strong>  Give the pool a name. In our case, we call it LOVE.  The result should look something like this:</p>
<pre><code> &gt;&gt; POOL &gt;&gt; NEW
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Pool Name: LOVE

Pool: LOVE
PoolPubKey: 687c3f588d996ee5fc751cc581826f63c407b1c46514ef9fe3001fa96d3a75bc
Start cardano node with the following run arguments:
--shelley-kes-key /opt/cardano/cnode/priv/pool/LOVE/hot.skey
--shelley-vrf-key /opt/cardano/cnode/priv/pool/LOVE/vrf.skey
--shelley-operational-certificate /opt/cardano/cnode/priv/pool/LOVE/op.cert
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre>
<ol start="4">
<li>Start or restart your cardano-node with the parameters as shown.  This will ensure your node has all the information necessary to create blocks.<br />
<strong>IMPORTANT</strong> - If you do not start your node with these parameters you won't be able to make blocks.</li>
</ol>
<h4><a class="header" href="#register-pool" id="register-pool">Register Pool</a></h4>
<p><strong>1.</strong>  From the main menu select <code>Pool [p]</code><br />
<strong>2.</strong>  Select <code>Register [r]</code><br />
<strong>3.</strong>  Select the pool you just created in step 11 above<br />
<strong>4.</strong>  CNTools will give you prompts to set metadata, pledge, margin and cost. Enter values that are useful to you.<br />
<strong>IMPORTANT</strong> - Make sure you set your pledge low enough to insure your funds in your wallet will cover pledge plus pool registration fees.</p>
<p>It will look something like this:</p>
<pre><code> &gt;&gt; POOL &gt;&gt; REGISTER
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Select Pool:

  LOVE
  [c] Cancel

Pledge (in ADA, default: 50000): 899
Margin (in %, default: 7.5): 10
Cost (in ADA, default: 256): 500
Enter Pool's Name (default: LOVE):
Enter Pool's Ticker , should be between 3-5 characters (default: LOVE):
Enter Pool's Description (default: No Description): My custom description
Enter Pool's Homepage (default: https://foo.com): https://love.fake.com
Enter Pool's JSON URL to host metadata file - URL length should be less than 64 chars (default: https://foo.bat/poolmeta.json): https://love.fake.com/poolmeta.json

Please make sure you host your metadata JSON file (with contents as below) at https://love.fake.com/poolmeta.json :
{
  &quot;name&quot;: &quot;LOVE&quot;,
  &quot;ticker&quot;: &quot;LOVE&quot;,
  &quot;description&quot;: &quot;My custom description&quot;,
  &quot;homepage&quot;: &quot;https://love.fake.com&quot;
}
</code></pre>
<p><strong>5.</strong>  Select the wallet you want to register the pool with.<br />
<strong>6.</strong>  DONE!</p>
<p>The final output on successful registration should look something like this:</p>
<pre><code>New block was created - 23414

Pool LOVE successfully registered using wallet bob for pledge
Pledge : 899 ADA
Margin : 10%
Cost   : 500 ADA
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre>
<h1><a class="header" href="#block-collector" id="block-collector">Block Collector</a></h1>
<p>For the core node(block producer) the <code>cntoolsBlockCollector.sh</code> script can be run to monitor the json log file created by cardano-node for traces related to leader slots and block creation. Data collected is stored in a json file, one for each epoch. To view the collected data the main CNTools script is used.</p>
<p>This collector does not in any way replace a proper database like db-sync but can be a good lightweight way of keeping track of slots assigned and if blocks were successfully created. It currently does not verify that the block created makes it onto the chain. If possible this will be added at a later stage.</p>
<ul>
<li><a href="Scripts/cntools-blocks.html#prerequisites">Prerequisites</a></li>
<li><a href="Scripts/cntools-blocks.html#installation-and-configuration">Installation and Configuration</a></li>
<li><a href="Scripts/cntools-blocks.html#view-collected-blocks">View Collected Blocks</a></li>
</ul>
<h3><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h3>
<p>It's assumed the <a href="Scripts/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> have already been run.</p>
<p>As the block collector relies on the cardano-node log file for block traces the node configuration file has to be set up in a certain way for it to work. The file used comes from <code>CONFIG</code> parameter in <code>env</code> file.</p>
<ul>
<li>setupScribes configured with <code>scKind: FileSK</code> and <code>scFormat: ScJson</code> as well as a file extension of <code>.json</code></li>
<li>Blocks traces enabled. The script is looking for the following block traces in the log file, more block traces might be added in the future.<br />
<code>TraceNodeIsLeader TraceAdoptedBlock TraceForgedInvalidBlock</code></li>
</ul>
<h3><a class="header" href="#installation-and-configuration" id="installation-and-configuration">Installation and Configuration</a></h3>
<p>The script is best run as a background process. This can be accomplished in many ways but the preferred method is to run it as a  systemd service. A terminal multiplexer like tmux or screen could also be used but not covered here.</p>
<p>sudo/root access needed to configure systemd.</p>
<p>In this example normal output from the <code>cntoolsBlockCollector.sh</code> script is ignored. Error output is logged using syslog and end up in the systems standard syslog file, normally <code>/var/log/syslog</code>. Other logging configurations are not covered here. </p>
<p><strong>1. Create systemd service file</strong><br />
Replace <code>$USER</code> with the correct user for your system. Copy &amp; paste all code below to create the service file.</p>
<pre><code class="language-bash">sudo bash -c 'cat &lt;&lt;EOF &gt; /etc/systemd/system/cntools-blockcollector.service
[Unit]
Description=CNTools - Block Collector
After=network.target

[Service]
Type=simple
Restart=on-failure
RestartSec=10
User=$USER
WorkingDirectory=/opt/cardano/cnode/scripts
ExecStart=/opt/cardano/cnode/scripts/cntoolsBlockCollector.sh
SuccessExitStatus=143
StandardOutput=null
StandardError=syslog
SyslogIdentifier=cntools-blockcollector

[Install]
WantedBy=multi-user.target
EOF'
</code></pre>
<p><strong>2. Reload systemd</strong></p>
<pre><code>sudo systemctl daemon-reload
</code></pre>
<p><strong>3. Start block collector</strong><br />
Run below commands to enable automatic start of service on startup and start it.</p>
<pre><code>sudo systemctl enable cntools-blockcollector.service
sudo systemctl start cntools-blockcollector.service
</code></pre>
<h3><a class="header" href="#view-collected-blocks" id="view-collected-blocks">View Collected Blocks</a></h3>
<p>Start CNTools and choose <code>Blocks [b]</code> to open the block viewer.<br />
Enter the epoch you want to see or press <code>enter</code> to see the current epoch.</p>
<p>If the node was elected to create blocks in the selected epoch it could look something like this:</p>
<pre><code> &gt;&gt; BLOCKS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Current epoch: 92

Enter epoch to list (enter for current):

7 blocks created in epoch 92

Slot   At                       Size  Hash
82809  2020-06-26 12:15:18 UTC  3     bd86e0358fbc929daeb0a877052149bcb57e2b2d7da573ea025c78cc2ed6896b
82811  2020-06-26 12:15:22 UTC  3     fcd8e33f56b7a7d0c3a426570b8a1fba045266fd1a40ff63951c0f00fc7fbeb4
82829  2020-06-26 12:15:58 UTC  3     d0804a37eee8dfaaeb39a06e3373adef51459b1429b838288291014a69c37c04
82851  2020-06-26 12:16:42 UTC  3     d18c27edfdc2870d7922039d48764502f9b27b157b92b0dbe7171c35b1c94f5f
82859  2020-06-26 12:16:58 UTC  3     e9a1efdd3aef257ea07c55e102ad976c2259ee3cacc9a1d45f7c9dc55db189e9
82881  2020-06-26 12:17:42 UTC  3     d5bf67db9bcb6a26968b69dc9e65c540402bed985b46e98a925aa679adb51c88
82913  2020-06-26 12:18:46 UTC  3     1bf29f81d8087ded9f268a2b89aef2c7c6eeda077e5b84941aa4732bea1c3e0c
</code></pre>
<h3><a class="header" href="#create-keysaddress" id="create-keysaddress">Create Keys/Address</a></h3>
<p>This script assists you to create a Private key file and generates a corresponding address script for it</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts
./createAddr.sh key1
# Sample output to enter passphrase (can be left empty, you will need this passphrase to access the key if filled):
# Enter password to encrypt 'key1':
# Repeat to validate:
</code></pre>
<h3><a class="header" href="#check-balance" id="check-balance">Check Balance</a></h3>
<p>This script will check balance of address specified as command line argument</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts

./balance.sh 61WKMJemoBa....ssL7fzhq
                           TxHash                                 TxIx        Lovelace
----------------------------------------------------------------------------------------
WKMJemoBa4a9dc77d6d36cfbd90ae0e693e5e99ad59c09a8455169assL7fzhq     0        1000000000

Total balance in 1 UTxO is 1000000000 Lovelace or 1000 ADA
</code></pre>
<h3><a class="header" href="#make-transactions" id="make-transactions">Make Transactions</a></h3>
<p>This script will create and submit a transaction to send ADA from source address to destination address, it assumes the <a href="Scripts/Common.html#dependencies-and-folder-structure-setup">pre-requisites</a> are already in place.<br />
The script can also be used to defrag address by setting destination and source address to the same and amount to the string 'all'</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts

./sendADA.sh

Usage: sendADA.sh &lt;Destination Address&gt; &lt;Amount&gt; &lt;Source Address&gt; &lt;Source Sign Key&gt; [--include-fee]

  Destination Address   Address or path to Address file.
  Amount                Amount in ADA, number(fraction of ADA valid) or the string 'all'.
  Source Address        Address or path to Address file.
  Source Sign Key       Path to Signature (skey) file. For staking address payment skey is to be used.
  --include-fee         Optional argument to specify that amount to send should be reduced by fee instead of payed by sender.
</code></pre>
<h1><a class="header" href="#quickstart-for-using-topology-updater" id="quickstart-for-using-topology-updater">Quickstart for using TOPOLOGY-UPDATER</a></h1>
<p>Since the test network has to get along without the P2P network module for the time being, it needs static topology files. This &quot;TopologyUpdater&quot; service, which is far from being perfect due to its centralization factor, is intended to be a temporary solution to allow everyone to activate their relay nodes without having to postpone and wait for manual topology completion requests.</p>
<p>The topologyupdater shell script must be executed on the relay node as a cronjob exactly every 60 minutes. After 4 consecutive requests (3 hours) the node is considered a new relay node in listed in the topology file. If the node is turned off, it's automatically delisted after 3 hours.</p>
<h4><a class="header" href="#download-and-configure-topologyupdatersh" id="download-and-configure-topologyupdatersh">Download and Configure topologyUpdater.sh</a></h4>
<p>If you have run <code>prereqs.sh</code>, this should already be available in your scripts folder and make this step unnecessary. </p>
<p>Before the updater can make a valid request to the central topology service, he must query the current tip/blockNo from the well synced local node. It connects to your node through the configuration in the script (note: not the usual env file, as cronjobs don't run in the same environment). Customize this file for your needs.</p>
<p>To download topologyupdater.sh manually you can execute the commands below:</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts
curl -s -o topologyUpdater.sh https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/topologyUpdater.sh
chmod 750 topologyUpdater.sh
</code></pre>
<h4><a class="header" href="#start-1" id="start-1">Start</a></h4>
<p>Then add the script to be executed once per hour at a minute of your choice (eg xx:25 o'clock in the example below)</p>
<pre><code>25 * * * * /opt/cardano/cnode/scripts/topologyUpdater.sh
</code></pre>
<p>you can check the last result in <code>logs/topologyUpdater_lastresult.json</code></p>
<h1><a class="header" href="#step-by-step-to-have-your-relay-node-listed-in-the-topology" id="step-by-step-to-have-your-relay-node-listed-in-the-topology">Step by Step to have your relay node listed in the topology</a></h1>
<p><em>Note:</em> You don't need to execute this for your pool nodes. </p>
<p>You need to execute it once for every relay node you run. (IP:PORT combination)</p>
<p>If one of the parameters is outside the allowed ranges, invalid or missing the returned json will tell you what needs to be fixed.</p>
<p>Don't try to execute the script more often than once per hour. It's completely useless and may lead to a temporary blacklisting.</p>
<h1><a class="header" href="#where-is-the-topology-file" id="where-is-the-topology-file">Where is the topology file?</a></h1>
<p>Each subscribed node (4 consecutive requests) is allowed to fetch a subset of other nodes. </p>
<p>Engineers of cardano-node network stack suggested to use around 20 peers. More peers create unnecessary and unwanted system load and delays.</p>
<p>The URL to fetch the peer list is <a href="https://api.clio.one/htopology/v1/fetch/">https://api.clio.one/htopology/v1/fetch/</a></p>
<p>In it's default setting it returns a list of 15 remote peers. The <code>max</code> parameter allows to define a number between 1 and 20 remote peers.</p>
<p>you can request the file from you node by using the curl command</p>
<pre><code>curl -s -o path/to/topology.json &quot;https://api.clio.one/htopology/v1/fetch/?max=14&quot;
</code></pre>
<p>Don't forget to restart your node to load the new topology. </p>
<h2><a class="header" href="#and-my-custom-peers-internal-pools-" id="and-my-custom-peers-internal-pools-">and my custom peers (internal pools) ?</a></h2>
<p>There is also a <code>customPeers</code> parameter, to include also some custom peers you want included in the topology json file.  Every custom peer is defined in the form [address]:[port] and optional :[valancy]. Multiple custom peers are separated by | </p>
<p>A complete example looks like</p>
<pre><code>curl -s -o topology.json &quot;https://api.clio.one/htopology/v1/fetch/?max=12&amp;customPeers=10.0.0.1:3001|10.0.0.2:3002|relays.mydomain.com:3003:3&quot;
</code></pre>
<p>Might think about including the curl command in your startup script before cardano-node.</p>
<h2><a class="header" href="#how-are-the-peers-for-my-topology-file-selected" id="how-are-the-peers-for-my-topology-file-selected">How are the peers for my topology file selected?</a></h2>
<p>We calculate the distance on the earth's surface from your nodes IP to all subscribed peers. We then order by distance (closest first) and start selecting one peer. Then skip some, pick the next, skip, pick, skip, pick ... until we reach the end of the list (furthest away). The number of skipped records is calculated in a way to have the desired number of peers at the end.</p>
<p>Every requesting node has his personal distances to all other nodes. </p>
<p>We assume this should result in a well distributed and interconnected peering network.</p>
<h1><a class="header" href="#shelley-staking" id="shelley-staking">Shelley Staking</a></h1>
<p>This guide's chapter targets the pool operators for getting their head around of Shelley staking. The network references used for this guide are for Friends anf Family Network, and the user is expected to update testnet-magic as desired.
To fully understand the staking mechanism we need to define and interpret the following key concepts:</p>
<ul>
<li>What are the <a href="Staking/./Keys.html">keys</a></li>
<li>What are the <a href="Staking/./Addresses.html">addresses</a></li>
<li>What are the <a href="Staking/./Certificates.html">certificates</a> and </li>
<li>Who are the <a href="Staking/./StakeHolders.html">stake holders</a> that are participanting in staking.</li>
</ul>
<h2><a class="header" href="#keys-addresses-and-certifications" id="keys-addresses-and-certifications">Keys, Addresses and Certifications</a></h2>
<p>The following picture helps to understand the relations between keys, addresses and certificates.</p>
<p><img src="https://raw.githubusercontent.com/ilap/ShelleyStuffs/master/images/ShelleyKeyAndAddresses.png" alt="ShelleyKeyAndAddresses" /></p>
<h2><a class="header" href="#key-types-and-their-functions" id="key-types-and-their-functions">Key Types and their functions</a></h2>
<p>Keys are just simply asymmetric cryptography key pairs (private/public, signing/verifying) that are used for signing and validating payments and staking related certificates and identifying, defining addresses on the Cardano blockchain.</p>
<p>As it can be seen in the picture there are two main type of keys in Shelley:</p>
<ul>
<li><strong>Node keys</strong> and</li>
<li><strong>Address keys</strong>.</li>
</ul>
<p>The node keys are relevant to the security of the blockchain while the address keys are relevant to the functions of the addresses derived from the keys for identifying funds on the blockchain.
See details below and above in the picture.</p>
<ol>
<li>Node Keys
<ul>
<li>Operator/operational key: operator's offline key pair with cert counter for new certificates. </li>
<li>Hot KES key: operator's hot KES key pair.</li>
<li>Block signing key: operational VRF key pair, it participates in the &quot;lottery&quot; i.e. right to create and sign the block for the specific slot.</li>
</ul>
</li>
<li>Address (Payment, Staking etc.) keys
<ul>
<li>Payment key: single address key pair (usually for generating UtxO addresses)</li>
<li>Staking key: stake/reward address key pair (usually generating account/reward addresses)</li>
</ul>
</li>
</ol>
<h2><a class="header" href="#addresses-and-their-functions" id="addresses-and-their-functions">Addresses and their functions</a></h2>
<p>The addresses, as of now, are just a simple <code>blake2b-256</code> hash of the relevant veryifying/public keys contatenated with some metadata that are or can be stored on the <code>Cardano</code> blockchain. </p>
<blockquote>
<p>Addresses in this context are only relevant to the ledger specification and not to any wallet addresses.
So, the wallets <code>m/44'/1852'/0'/{0,1,2}</code> <code>bech32</code> addresses (e.g. <code>ca1hg9...</code>) are irrelevant here.</p>
</blockquote>
<p>Currently there are three main type of addresses and a reserved <em>address space</em> for future use:</p>
<ol>
<li><strong>Payment addresses</strong>: 
<ul>
<li>base addresses (can participate in staking, a.k.a goup addresses in ITN jorm terminology)</li>
<li>pointer addresses (need to check whether it can or cannot participate in staking)</li>
<li>enterprise addresses (cannot participate in staking a.k.a UtxO address)</li>
</ul>
</li>
<li><strong>Reward addresses</strong>: Reward/account addresses (can participate in staking)</li>
<li><strong>Byron addresses</strong>: The legacy addresses, for backward compatibility (cannot participate in staking)</li>
<li><strong>Future addresses</strong>: possible 5 main /w 16 subtypes or 80 additional address types)</li>
</ol>
<p>Therefore addresses, in Cardano Shelley (only in Haskell code), are some serialised data specified in the ledger specification that are stored in the blockhain's blocks (e.g. an UtxO address).</p>
<p>The serialised data (address) contains two parts the <strong>metadata</strong> and <strong>payload</strong> (i.e. <code>address = metadata + payload</code>): </p>
<ul>
<li>metadata: is for interpreting the</li>
<li>payload: the raw or encoded bytes. For example the verifying/public keys or their hashes or even scripts (e.g. plutus smart contract) hashes.</li>
</ul>
<p><em>Therefore, in layman definition (by removing some complexity for easy understanding): 
<strong>Addresses are serialised public/verifying keys</strong></em> </p>
<p>See,the <a href="https://github.com/input-output-hk/cardano-ledger-specs/blob/master/shelley/chain-and-ledger/executable-spec/cddl-files/shelley.cddl#L66">detailed address specification here</a>.</p>
<blockquote>
<p>Pls, keep in mind, that it does not mean that the specification is currently is used, implemented and/or finalised.</p>
</blockquote>
<h2><a class="header" href="#certificates" id="certificates">Certificates</a></h2>
<p>Shelley's PoS protocol requires different certificates posted to the blockhain; which will be pulbicyl available for all participants. Those are valids until explicitly overwritten or revoked.</p>
<p>There are four main type of certificates are in Shelley:</p>
<ol>
<li>Operational key certificates (<strong>off chain</strong>),</li>
<li>Stake Key registration certificates (<strong>on chain</strong>),</li>
<li>Delegation certificates (<strong>on chain</strong>) and</li>
<li>Stake pool certificates (<strong>on chain</strong>).</li>
</ol>
<h3><a class="header" href="#operational-key-certificates" id="operational-key-certificates">Operational key certificates</a></h3>
<p>The <code>operational key certificate</code>'s is created from a <code>staking key</code>
used by stake pool operators for protecting their pool(s) and keys, signing bocke, participating in the lottery and not for delegating staking rights.
This certificate needs for operating a node as a stake pool. </p>
<p>See <a href="Staking/./Operators.html#run-a-node-with-operational-key-certificate">detailed example here</a></p>
<h3><a class="header" href="#stake-key-registration-certificates" id="stake-key-registration-certificates">Stake Key registration certificates</a></h3>
<p>All participants, who want to participate in staking, need to register a <strong>stake key</strong> on the blockchain by posting a <strong>stake key registration certificate</strong>. The registration requires a key deposit specified in the genesis (400K lovelace for FnF), but do not require any <code>signature</code> signed by the corresponding <code>stake signing key</code>.</p>
<p>The registration is revoked when a de-registration certificate signed by the account's <code>stake signing key</code> is posted to the blockchain, causing the account to be deleted (<strong>Ask what is the impact of this</strong>).</p>
<p>See <a href="Staking/./Operators.html#create-stake-key-registration-certificate">detailed example here</a></p>
<h3><a class="header" href="#delegation-certificates" id="delegation-certificates">Delegation certificates</a></h3>
<p>Delegation certificates uses a <code>staking key</code> to grant the right to sign blocks to another key. </p>
<p>See <a href="Staking/./Operators.html#create-the-stake-owners-delegation-certificate">detailed example here</a></p>
<h3><a class="header" href="#stake-pool-certificates" id="stake-pool-certificates">Stake pool certificates</a></h3>
<p>A node for operating as a stake pool must post a <code>stake pool registration certificate</code> signed by all the owners' <code>staking signing key</code> and the pool operator's <code>operational signing key</code>. </p>
<p>To revoke the certificate a <code>stake pool retirement certificate</code> must be posted to the chain signed by <strong>only</strong> the pool's <code>operational signing key</code>.</p>
<p>No owner(s) is/are required to sign the retirement certificate.</p>
<p>See <a href="Staking/./Operators.html#run-a-node-with-operational-key-certificate">detailed example here</a></p>
<h2><a class="header" href="#the-stake-holders" id="the-stake-holders">The Stake Holders</a></h2>
<p>Tha stake holders in simple words are those who are participating in stakings, namely:</p>
<ul>
<li><a href="Staking/./Operators.html">Operators</a>, who operate staking pools,</li>
<li><a href="Staking/./Owners.html">Owners</a>, who own a pool, in some extent, by pledging their stakes to pools and the</li>
<li><a href="Staking/./Delegates.html">Delegates</a>, who delegate their staking rights to stake pools.</li>
</ul>
<p>For participating in staking, every stake holder must have some form of different type of <code>address keys</code>:</p>
<ul>
<li>payment keys, which can or cannot participate in staking and </li>
<li>staking keys for receiving staking (stake or pool)  rewards.</li>
</ul>
<h3><a class="header" href="#owners" id="owners">Owners</a></h3>
<p>The owners are the stake holders who have some funds deposited and want to own, in some extent, a staking pool. The owner's objectives are the following:</p>
<ul>
<li>Create <code>payment key(s)</code> for generating <code>base</code> payment addresses.</li>
<li>Create <code>stake key(s)</code> for generating  <strong>pool</strong> <code>reward address</code>.</li>
<li>Create and submit the owner's <code>delegation certificate</code> for pledging.</li>
</ul>
<blockquote>
<p>Note: In this example the operator's stake and payment keys will be used for pledging.
That means the the <strong>operator</strong> is the <strong>owner</strong>.</p>
</blockquote>
<p>See <a href="Staking/./Operators.html">detailed example here</a></p>
<h3><a class="header" href="#operators" id="operators">Operators</a></h3>
<p>The operator(s) is/are the stake holder(s) who operating a pools. The operators can define their operational costs in the pool certificate, that can be deducted from the rewards.</p>
<p>The objectives are the following:</p>
<ul>
<li>Understand <strong>off-chain</strong> <code>operational key certificates</code>,</li>
<li>the required keys and addresses,
<ul>
<li><code>payment key(s)</code> for generating <code>base</code> payment addresses,</li>
<li><code>stake key(s)</code> for generating  <strong>pool</strong> <code>reward address(es)</code>,</li>
</ul>
</li>
<li>the stake address registration process <strong>with</strong> <code>key deposit</code> and</li>
<li>the stake pool registration procedure /w pledge and other params.</li>
</ul>
<p>Detailed steps are:</p>
<ul>
<li>Run a node with an <code>operational key certificate</code></li>
<li>Create stake key registration certificate for registering the operator's stake key (<code>staking.key</code>) on the chain, then</li>
<li>Create a pool registration certificate for the node to became a stake pool (<code>pool.cert</code>),</li>
<li>Create a delegation certificate for the owner (operator in our exercise) to delegate its stake as pledge to the newly creating pool (<code>deleg.cert</code>).</li>
<li>Sends the <strong>on-chain</strong> certificates to the blockchain in one or more transactions.</li>
</ul>
<h4><a class="header" href="#run-a-node-with-operational-key-certificate" id="run-a-node-with-operational-key-certificate">Run a node with Operational Key Certificate</a></h4>
<p>The operational key certificates use an <strong>operational key</strong> (cold) key to grant the right to sign blocks to another key (KES) that will expire after some epochs, that is based on the genesis parameters. </p>
<p>It uses a similar mechanism to the <code>forward secure signature scheme</code> where the signing key (KES) changes over time period and the end of each time period a new signing key is computed for the next peried and the old one is erased. </p>
<p>The mechanism used for running a node with <code>operational key certificates</code> are the following: </p>
<ol>
<li>KES (Key Evolving Signatures) that creates new (hot) KES keys periodically from the cold key
<ul>
<li>Create the cold (offline) key pair,</li>
<li>Create the hot KES key pairs (periodically), for signing blocks.</li>
<li>Create the <code>operational key certificate</code></li>
</ul>
</li>
<li>Generate VRF key pair for leader selection (lottery).</li>
<li>Run stake pool that is using the</li>
</ol>
<ul>
<li>non expired Operational certificate</li>
<li>non expired KES (hot) signing key</li>
<li>VRF signing key</li>
</ul>
<p>Before the old hot (KES) key pair is expiring, a new <code>operational key certificate</code> needs to be created by using a newly generated hot (KES) key pair and the <strong>off-line</strong> cold signing key.</p>
<p>In production environment, it is expected that the cold key is generated by some seed generation mechanism (BIP39 or similar) and stored on computer that does not have access to the Internet and when the time arrives, the operational certificates with the hot (KES) key pairs are transferred, by some mechanism (USB stick, air gapped QR etc.) to the stake pool.</p>
<pre><code class="language-bash"># 1.1 Create cold key pair
##########################################
pushd  $CNODE_HOME &amp;&amp; mkdir -p ~/cold-keys &amp;&amp; pushd ~/cold-keys || exit 127

# Generate the cold offline key pair
cardano-cli shelley node key-gen \
    --verification-key-file cold.vkey \
    --signing-key-file cold.skey \
    --operational-certificate-issue-counter cold.counter
popd

# 1.2 Generate a new hot KES keypair 
cardano-cli shelley node key-gen-KES --verification-key-file priv/kes.vkey --signing-key-file priv/kes.skey

# 1.3 Generate the ops cert based on 
# - the `cold signing key`
# - the hot KES key and
# - the cold key's counter
# New periodic cert is based on the new hot KES key.
# kes-period tells how long the ops cert therefrore the hot KES keys are valid
#
cardano-cli shelley node issue-op-cert \
    --cold-signing-key-file ~/cold-keys/cold.skey \
    --operational-certificate-issue-counter ~/cold-keys/cold.counter \
    --hot-kes-verification-key-file priv/kes.vkey \
    --kes-period 0 \
    --out-file priv/op.cert

# 2. Generate VRF key pair for leader selection
#########################################################
cardano-cli shelley node key-gen-VRF --verification-key-file priv/vrf.vkey --signing-key-file priv/vrf.skey

# 3. Run node /w these new keys generated
#########################################################

cardano-node run \
  --config                          files/config.json \
  --topology                        files/topology.json \
  --database-path                   db \
  --socket-path                     sockets/nodes.socket \
  --shelley-kes-key                 priv/kes.skey \
  --shelley-vrf-key                 priv/vrf.skey \
  --shelley-operational-certificate priv/op.cert \
  --port                            6000 

</code></pre>
<p>I will use the initial genesis address as input for registering the:</p>
<ul>
<li>delegate registration certificate and</li>
<li>pool registration certificate</li>
</ul>
<blockquote>
<p>Keep in mind the operator also need to have its stake key registered onn the chain.</p>
</blockquote>
<h4><a class="header" href="#create-stake-key-registration-certificate" id="create-stake-key-registration-certificate">Create stake key registration certificate</a></h4>
<p>First we need to create the operator's key in order to register the key on the chain.</p>
<p>The delegate's <code>staking key</code> needs to be registered on the blockchain in order to participating in staking, which just need a simple transaction using any <code>payment address</code>.</p>
<blockquote>
<p>This is the pool operators's stake key, and not the delegate's one. 
Therefore I prefixed them it differently i.e. <code>staking</code>, to distuinguish between the delegate's (<code>stake</code>) prefix.</p>
</blockquote>
<pre><code class="language-bash">mkdir operator &amp;&amp; pushd operator

# Generate the operator's stake keys
cardano-cli shelley stake-address key-gen --verification-key-file staking.vkey --signing-key-file staking.skey

# crate teh reward (staking) address from the operator's stake keys
cardano-cli shelley stake-address build --stake-verification-key-file staking.vkey --testnet-magic 42 &gt; staking.addr

# Generate the operator's payment keys
cardano-cli shelley address key-gen --verification-key-file op_pay.vkey --signing-key-file op_pay.skey

# Generate an `enterprise` address for the operator.
cardano-cli shelley address build --payment-verification-key-file op_pay.vkey --testnet-magic 42 &gt; op_pay.addr

# Generate the base address  i.e. compount `enterprise || reward` address
cardano-cli shelley address build \
    --payment-verification-key-file op_pay.vkey \
    --stake-verification-key-file staking.vkey \
    --testnet-magic 42 &gt; base.addr
</code></pre>
<p>The next step is creating a stake address registration certificate.</p>
<p>For registering an <code>stake key</code> on the chain a <code>key deposit1</code> fee must be paid. The amount can be optained from the genesis for the params file e.g.:</p>
<pre><code class="language-bash">cardano-cli shelley query protocol-parameters --testnet-magic 42 | tee params.json | jq -r .keyDeposit
400000
</code></pre>
<p>Generate the operator's stake key registration certificate </p>
<p>Keep, in mind that the a <code>key registration certificates</code> needs a deposit (<strong>keyDeposit</strong> in genesis) for the costs of tracking the key and the corresponding reward account. Also, it does not require any witness to register the certificate, but only the witness for the fees from the input of the transaction.</p>
<pre><code class="language-bash"># Keep in mind that this certificates needs a `keyDeposit` specified in the genesis.
cardano-cli shelley stake-address registration-certificate \
    --stake-verification-key-file staking.vkey \
    --out-file staking.cert
# The certificate contains the `blake2b-256` hash of the stake verifying key

# Calculate the min fee for the following outputs:
# 1. the base address that will contain the funds for pledge
# 2. And the change address.
# Keep in mind just one signing key is required, the paying signing key,
# as stake key reg cert does not need t obe witnessed
cardano-cli shelley transaction calculate-min-fee \
    --tx-in-count 1 \
    --tx-out-count 2 \
    --ttl 500000 \
    --testnet-magic 42 \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --certificate-file staking.cert \
    --protocol-params-file params.json
# 
# runTxCalculateMinFee: 174169

# INPUT will be based on the genesis addres (FROM)
# but any pay address is fine.
FROM=&quot;617190446876aed298ee207c6b5a335e832e2169a060b8167ef3ba9caff6fa3393&quot;

cardano-cli shelley query utxo --testnet-magic 42 --address &quot;$FROM&quot;
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#c85b72ee021915f5a8349209db54a51334ad9dfcec2f0fa2619a707556017bb3     0      499999825831

INPUT=&quot;c85b72ee021915f5a8349209db54a51334ad9dfcec2f0fa2619a707556017bb3#0&quot;
BALANCE=499999825831
# The amount will be 400K and I will pladge all of it to the pool
AMOUNT=400000000000
KEYDEP=400000
FEE=174169
CHANGE=&quot;$FROM+$(( 499999825831 - $FEE - $KEYDEP - $AMOUNT ))&quot;


# So, I used the genesis UtxO to move to some staking (group) address and 500K back to it.
cardano-cli shelley transaction build-raw \
    --tx-in &quot;$INPUT&quot; \
    --tx-out $(cat base.addr)+$AMOUNT \
    --tx-out &quot;$CHANGE&quot; \
    --ttl 500000 \
    --fee &quot;$FEE&quot; \
    --out-file staking-cert.tx \
    --certificate-file staking.cert

# Sign it
cardano-cli shelley transaction sign \
    --tx-body-file staking-cert.tx \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --testnet-magic 42 \
    --out-file signed-staking-cert.tx

# Submit it
cardano-cli shelley transaction submit \
    --tx-file signed-staking-cert.tx \
    --testnet-magic 42
</code></pre>
<h4><a class="header" href="#create-a-pool-registration--certificate" id="create-a-pool-registration--certificate">Create a pool registration  certificate</a></h4>
<p>A node needs a <code>pool certificate</code> registered on the blockchain for the operator to became a stake pool (<code>pool.cert</code>),</p>
<p>Now we have a 400K on the operator's <code>base address</code> and the stake key (<code>staking.key</code>) is registered.</p>
<pre><code class="language-bash">cardano-cli shelley query utxo --testnet-magic 42 --address $(cat base.addr)
                           TxHash                                 TxIx        Lovelace
----------------------------------------------------------------------------------------
863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74     0      400000000000
</code></pre>
<p>In the operator's PoV, for registering a pool, the pool certificate must contain:</p>
<ul>
<li>a <code>node operational verifying key</code> a.k.a. <code>cold key</code>, for generating the pool id.</li>
<li>the <code>VRF verifyig key</code> a.k.a <code>hot key</code>, for lottery, to prove that the node has the right to create and sign a block,</li>
<li>an operator <code>stake verifying keys</code> for generating the reward address, where the pool rewards would be sent and</li>
<li>owner's <code>stake verifying keys</code> generating the pledge <code>staking</code> address, that has enough fund for pledging.</li>
</ul>
<blockquote>
<p>Note: the <code>reward account verification key</code> and the <code>owner staking verification key</code> can be the same is, see below example, if the operator is the owner too.</p>
</blockquote>
<p>Also, for registering a pool certificate a <code>pool deposit</code> must be paid too.</p>
<pre><code class="language-bash"># Createing a pools cert with
# - 400K of the owner's (operator in this example) 400K pledge, 
# - 1k as cost /w 
# - 5% margin
cardano-cli shelley stake-pool registration-certificate \
    --cold-verification-key-file ~/cold-keys/pool.vkey \
    --vrf-verification-key-file $CNODE_HOME/priv/vrf.vkey \
    --pool-pledge 400000000000 \
    --pool-cost 1000000000 \
    --pool-margin 0.05 \
    --reward-account-verification-key-file staking.vkey \
    --pool-owner-staking-verification-key staking.vkey \
    --out-file pool.cert
</code></pre>
<h4><a class="header" href="#create-the-stake-owners-delegation-certificate" id="create-the-stake-owners-delegation-certificate">Create (the stake owner's) delegation certificate</a></h4>
<p>For <strong>pledging</strong>, the owner (in our example the operator) must create a <code>stake delegation certificate</code> for delegating at least a <code>pledge</code> amount of stake from the owner's <code>staking key</code> specified in the pool certificate.</p>
<p>In simple words, the owner is delegating its funds (<code>pledge</code>) to the pool he/she owns.</p>
<pre><code class="language-bash">cardano-cli shelley stake-address delegation-certificate \
    --stake-verification-key-file staking.vkey \
    --cold-verification-key-file ~/cold-keys/pool.vkey \
    --out-file owner-delegation.cert
</code></pre>
<h4><a class="header" href="#submit-the-certificate-to-the-chain" id="submit-the-certificate-to-the-chain">Submit the certificate to the chain</a></h4>
<p>The certificates can be sent in one transaction.</p>
<blockquote>
<p>Please, keep in mind that the registering a pool the operator's must pay a (decaying) <code>pool deposit</code> fee.</p>
</blockquote>
<pre><code># grep -i poolDeposit params.json
#  &quot;poolDeposit&quot;: 500000000,
# or 
# cardano-cli shelley query  protocol-parameters --testnet-magic 42 | jq '.poolDeposit'
# 500000000


# Calculate the fee for sending the both certificates the
# - pool registration certificate and the
# - owner's (in our case the operator's) delegating certificate.
#
# Also, it will be paid by my genesis key, but any valid `payment` signing key would do that 
# has the fee and the deposit
cardano-cli shelley transaction calculate-min-fee \
    --tx-in-count 1 \
    --tx-out-count 1 \
    --ttl 500000 \
    --testnet-magic 42 \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --signing-key-file staking.skey \
    --signing-key-file ~/cold-keys/pool.skey \
    --certificate-file pool.cert \
    --certificate-file owner-delegation.cert \
    --protocol-params-file ../params.json
# runTxCalculateMinFee: 184377

FEE=184377
POOLDEP=500000000

cardano-cli shelley query utxo --testnet-magic 42 --address &quot;$FROM&quot;
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74     1       99999251662

BALANCE=99999251662
INPUT=&quot;863506d0e7d1afcdb558ac4b021f2e7746f3c3178faecd11e1f0349ded141a74#1&quot;
CHANGE=&quot;$FROM+$(( $BALANCE - $FEE - $POOLDEP ))&quot;

# Build
cardano-cli shelley transaction build-raw \
     --tx-in &quot;$INPUT&quot; \
     --tx-out &quot;$CHANGE&quot; \
     --ttl 500000 \
     --fee &quot;$FEE&quot; \
     --out-file pool-cert.tx \
     --certificate-file pool.cert \
     --certificate-file owner-delegation.cert 

# Sign
# - the `genesis.skey` needs for signing the payment from the $FROM address.
# - the `staking.skey` needs for signing the owner's delegation certificate.
# - the `pool.skey` needs for signing the pool's registration certificate.
cardano-cli shelley transaction sign \
    --tx-body-file pool-cert.tx \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --signing-key-file staking.skey \
    --signing-key-file ~/cold-keys/pool.skey \
    --testnet-magic 42 \
    --out-file signed-pool-cert.tx

# Submit:
cardano-cli shelley transaction submit \
    --tx-file signed-pool-cert.tx \
    --testnet-magic 42

</code></pre>
<p>Done your pool is registered.</p>
<p>To check it you can you the following command:</p>
<pre><code class="language-bash"># Get the Pool Id whihc is in the owner-delegation.cert
POOL_ID=$( tail -1 owner-delegation.cert | cut -c 6- )
echo $POOL_ID
# 5820d07e860c52860d92373893b27d6926e6610c925f905eba40d8e930004bf2dc44
shelley query ledger-state  --testnet-magic 42 | grep &quot;poolPubKey&quot; | grep  &quot;$POOL_ID&quot;
#                    &quot;_poolPubKey&quot;: &quot;d07e860c52860d92373893b27d6926e6610c925f905eba40d8e930004bf2dc44&quot;,
</code></pre>
<h3><a class="header" href="#delegates" id="delegates">Delegates</a></h3>
<p>The delegates are the stake holders who have some funds deposited and want to participate in staking.
Therefore the steps for delegating stakes are the following:</p>
<ul>
<li>Create <code>stake key(s)</code> for generating the <strong>delegate</strong>'s <code>reward address(es)</code> for collecting their <code>stake rewards</code>.</li>
<li>Create <code>payment key(s)</code> for generating the <strong>delegate</strong>'s <code>payment address(es)</code> for payments that will participate in stake delegation and also deposititing some funds.</li>
<li>Register <code>stake address</code> on the blockhain, <strong>with</strong> key deposit, which is required for participatin in staking and </li>
<li>Create and submit the <strong>stake delegation certificate</strong> for the selected pool.</li>
</ul>
<h4><a class="header" href="#create-delegates-staking-keys-and-addresses" id="create-delegates-staking-keys-and-addresses">Create <em>delegate's</em> staking keys and addresses</a></h4>
<p>Stake address, derived from a <code>stake verification key</code>, is a simple <code>reward (account) address</code> which is not a <code>payment address</code> therefore it cannot be used as an output of a transaction.
In the <code>cardano-cli</code> they use a CBOR format for preventing it to be added as the input into a transaction.</p>
<blockquote>
<p>Keep in mind, that only the <strong>reward</strong> addresses and the <strong>base</strong>_, <strong>pointer</strong> and some <strong>script</strong> (not available yet) addresses can participate in the staking.</p>
</blockquote>
<p>First, we need to create the relevant <code>payment</code> and <code>stake</code> keys and the related addresses for the delegate. The payment address for paying the transactions for sending the <code>registration certificate</code> (which is just simply the reward account address in some CBOR encoded format) to the chain.</p>
<pre><code class="language-bash"># Delegate's staking/acount key, then Staking/Account address
############################################################
mkdir delegate &amp;&amp; pushd delegate
cardano-cli shelley stake-address key-gen --verification-key-file stake.vkey --signing-key-file stake.skey

cardano-cli shelley stake-address build --stake-verification-key-file stake.vkey --testnet-magic 42 &gt; stake.addr
cat stake.addr
#-------v 32 bytes key starts from here
8200582032a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb
# It's a CBOR representation of the vkey
#82                                      # array(2)
#   00                                   # unsigned(0)
#   58 20                                # bytes(32)
#      32A8C3F17AE5DAFC3E947F82B0B418483F0A8680DEF9418C87397F2BD3D35EFB # 
# &quot;2\xA8\xC3\xF1z\xE5\xDA\xFC&gt;\x94\x7F\x82\xB0\xB4\x18H?\n\x86\x80\xDE\xF9A\x8C\x879\x7F+\xD3\xD3^\xFB&quot;


# Delegates payment key -&gt; payment address (a.k.a legacy UtxO a.k.a enterprise address).
# Ur use some address that already has some fund on it.
############################################################
cardano-cli shelley address build --payment-verification-key-file pay.vkey --testnet-magic 42 &gt; pay.addr
cat pay.addr
# As a single Shelley UtXO address and (no CBOR repr)
# header(1) | address(32), so no hash224
# 0x61 = 0110 0001 || 0x47eb...2907 therefore an UtXO enterprise address
6147ebc8bf8714dcf6700ac482a5d42624ffca6afb51ae23930ea6591119a12907

####################################################################
# Generate the delegate's base address (0x01...) from 
# 1. the `pay.vkey` (used for enterprise address `0x61...`)
# 2. and from the `stake.key`
# It's a combination of the payment and reward address, with
# the 0b0000 0b0001, as a base address prefix
####################################################################
cardano-cli shelley address build \
    --payment-verification-key-file pay.vkey \
    --stake-verification-key-file stake.vkey \
    --testnet-magic 42 &gt; stake.base
</code></pre>
<h4><a class="header" href="#generating-the-staking-key-certificate" id="generating-the-staking-key-certificate">Generating the Staking key certificate</a></h4>
<pre><code class="language-bash"># First we need to generate the stake address registration
# certificate using the stake verification key
############################################################
cardano-cli shelley stake-address registration-certificate \
--stake-verification-key-file stake.vkey \
--out-file stake.cert

cat stake.cert
cbor-hex:
 18b482008200582032a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb
# 18 B4 # unsigned(180)
# 
#82                                      # array(2)
#   00                                   # unsigned(0)
#   82                                   # array(2)
#      00                                # unsigned(0)
#      58 20                             # bytes(32)
#         32A8C3F17AE5DAFC3E947F82B0B418483F0A8680DEF9418C87397F2BD3D35EFB  
# &quot;2\xA8\xC3\xF1z\xE5\xDA\xFC&gt;\x94\x7F\x82\xB0\xB4\x18H?\n\x86\x80\xDE\xF9A\x8C\x879\x7F+\xD3\xD3^\xFB&quot;
</code></pre>
<h4><a class="header" href="#registering-the-delegates-staking-key-on-chain" id="registering-the-delegates-staking-key-on-chain">Registering the delegate's staking key on chain</a></h4>
<p>The delegate's staking key needs to be registered in the blockchain, which just need a simple transaction using any payment address.</p>
<p>Keep, in mind that the any stake key registration certificates needs a deposit for the costs of tracking the key and the corresponding reward account. Also, it does not require any witness to register the certificate, but only the witness for the fees from the input of the transaction.</p>
<pre><code class="language-bash"># Get param files
export CARDANO_NODE_SOCKET_PATH=$CNODE_HOME/sockets/node0.socket
cardano-cli shelley query protocol-parameters \
--testnet-magic 42 \
--out-file params.json

# 3. Calc tx fee
# You need only one singing keys included in fee calculation:
# 1. the `payment` address signing key of the input
# as the stake key reg cert does not need witness
# One UtxO is enough for the change, but I will move some fund from genesis to the delegates address
FEE=$(cardano-cli shelley transaction calculate-min-fee \
--protocol-params-file params.json \
--certificate-file stake.cert \
--tx-in-count 1 \
--tx-out-count 2 \
--ttl 500000 \
--testnet-magic 42 \
--signing-key-file $CNODE_HOME/priv/genesis.skey \
| awk '{ print $2}')

# I will use the the genesis address as input for paying the fee.
#################################################################
FROM=$( cat $CNODE_HOME/priv/genesis.addr )
# i.e. FROM=617190446876aed298ee207c6b5a335e832e2169a060b8167ef3ba9caff6fa3393


TX=$(cardano-cli shelley query utxo --testnet-magic 42 --address &quot;$FROM&quot;  | grep &quot;^[^- ]&quot; | sort -k 2n | tail -1)
UTXO=$( echo &quot;$TX&quot; | awk '{ print $1 }')
ID=$( echo &quot;$TX&quot; | awk '{ print $2 }')
BALANCE=$( echo &quot;$TX&quot; | awk '{ print $3 }')
INPUT=&quot;${UTXO}#${ID}&quot;

# This 500K ADA amount is going to the delegates UtxO style address for its delegated stakes
TO=$(cat pay.addr)
AMOUNT=500000000000

OUTPUT1=&quot;${FROM}+${CHANGE}&quot;
OUTPUT2=&quot;${TO}+${AMOUNT}&quot;
# It also needs a key deposit specified in the genesis e.g.
# grep keyD
#    &quot;keyDeposit&quot;: 400000,
#    &quot;keyDecayRate&quot;: 0, Means the key won't decay, i.e. all money will
# get back when  the key is de-registered from the chain
KEYDEP=400000

# This means that change will less by 400K Lovelace that will be 
# probably (need to check) taken by the treasury 
CHANGE=$(( $BALANCE -  $FEE - $AMOUNT - $KEYDEP ))

echo &quot;Balance: $BALANCE, Amount: &quot;$AMOUNT&quot;,  Change: $CHANGE, runTxCalculateMinFee: $FEE&quot;
echo &quot;Input  : $INPUT&quot;
echo &quot;Output1: $OUTPUT1&quot;
echo &quot;Output2: $OUTPUT2&quot;

# Build
cardano-cli shelley transaction build-raw \
	--tx-in &quot;$INPUT&quot; \
	--tx-out &quot;${FROM}+${CHANGE}&quot; \
	--tx-out &quot;${TO}+${AMOUNT}&quot; \
	--ttl 500000 \
	--fee &quot;$FEE&quot; \
	--out-file stake-cert-tx
# Sign
cardano-cli shelley transaction sign \
    --tx-body-file stake-cert-tx \
    --signing-key-file $CNODE_HOME/priv/genesis.skey \
    --signing-key-file stake.skey \
    --out-file stake-cert-tx \
    --testnet-magic 42

# Submit
# Wait some minutes
# Get the stake address
# cut -c 9-  stake.addr 
# 32a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb
STAKE_ADDR=$( cut -c 9-  stake.addr )

# Before 
export CARDANO_NODE_SOCKET_PATH=$CNODE_HOME/sockets/node0.socket 
cardano-cli shelley query ledger-state  --testnet-magic 42 | grep &quot;$STAKE_ADDR&quot;


cardano-cli shelley transaction submit \
    --tx-file signed-stake-key-registration.tx \
    --testnet-magic 42

# After 
cardano-cli shelley query ledger-state  --testnet-magic 42 | grep &quot;$STAKE_ADDR&quot;
#                        &quot;contents&quot;: &quot;32a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb&quot;
#                        &quot;contents&quot;: &quot;32a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb&quot;
#                        &quot;contents&quot;: &quot;32a8c3f17ae5dafc3e947f82b0b418483f0a8680def9418c87397f2bd3d35efb&quot;

# Ready to delegate now.
</code></pre>
<h4><a class="header" href="#create-a-delegation-certificate-and-submit-to-the-network" id="create-a-delegation-certificate-and-submit-to-the-network">Create a delegation certificate and submit to the network</a></h4>
<pre><code class="language-bash"># You can use aither some pool from the google's spreadsheet 
echo &quot;type: Node operator verification key
title: Stake pool operator key
cbor-hex:
 5820&lt;the 32 bytes length of the pool's operational verification key from the google sheet without the 5820 CBOR tag.&gt;
 &quot; &gt; pool.vkey

# or delegate to your own pool by getting its `operational verifycation key` (the cold key)
# !! BE AWARE!! that the `stake.key` must have been already registered on the chain.
cardano-cli shelley stake-address delegation-certificate \
    --stake-verification-key-file stake.vkey \
    --cold-verification-key-file ~/cold-keys/pool.vkey \
    --out-file pool-delegation.cert

####################################################################
####################################################################

# Calculate the minimum fee.
cardano-cli shelley transaction calculate-min-fee \
    --tx-in-count 1 \
    --tx-out-count 1 \
    --ttl 500000 \
    --testnet-magic 42 \
    --signing-key-file pay.skey \
    --signing-key-file stake.skey \
    --certificate-file pool-delegation.cert \
    --protocol-params-file params.json
# runTxCalculateMinFee: 172805
FEE=172805
# Get the intput and balance
cardano-cli shelley query utxo --testnet-magic 42 --address $(cat stake.base)
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#1c089abfd6d56c73ac57aa94c403991041a383956f1f8fd4141a8e03a678a24c     0      499999260330

INPUT=&quot;1c089abfd6d56c73ac57aa94c403991041a383956f1f8fd4141a8e03a678a24c#0&quot;
BAL=499999260330
CHANGE=$(( $BAL - $FEE))
# The new `base address`
OUTPUT=&quot;$( cat stake.base)+$CHANGE&quot;

# Build
# Input: Your `base` payment address e.g. `stake.base` with &quot;0x01....&quot;
# Output: change back to the base address.
cardano-cli shelley transaction build-raw \
     --tx-in &quot;$INPUT&quot; \
     --tx-out &quot;$OUTPUT&quot; \
     --ttl 500000 \
     --fee &quot;$FEE&quot; \
     --out-file pool-delegation.tx \
     --certificate-file pool-delegation.cert

# Sign
# You need 2 signing keys
# 1. the `pay.skey` for wittness the input and
# 2. the `staking signing key` for signing the delegation certificate.
cardano-cli shelley transaction sign \
    --tx-body-file pool-delegation.tx \
    --signing-key-file stake.skey \
    --signing-key-file pay.skey \
    --testnet-magic 42 \
    --out-file signed-pool-delegation.tx

# Before

# Submit:
cardano-cli shelley transaction submit \
    --tx-file signed-pool-delegation.tx \
    --testnet-magic 42

# Done As less money is there.
# you need to wait two epochs to be receiving rewards
cardano-cli shelley query utxo --testnet-magic 42 --address $(cat stake.base)
#                           TxHash                                 TxIx        Lovelace
#----------------------------------------------------------------------------------------
#ba544d056f94e559076c0c7a0406f37ed7182a6d0fdc0cf2569498353f9dd797     0      499999087525

</code></pre>
<h3><a class="header" href="#welcome-1" id="welcome-1">Welcome!!</a></h3>
<p>This documentation (rather the repository itself) is created by some of the community members and serves as an easy means to add documentation or scripts that make more sense to users. The target audience for this document are mainly experienced stake pool operators.</p>
<p>The repository is already open to collaboration from many members within community. We would love community contributions and verification of the instructions, rather than having 100 versions of documentation. If there are any discrepancies/suggestions/contributions for this document, please open an Issue and one of the collaborators should be able to add the changes in.</p>
<h4><a class="header" href="#getting-started-with-haskell-node-1" id="getting-started-with-haskell-node-1">Getting Started with Haskell Node</a></h4>
<p>Use the sidebar to navigate through the topics. Note that the instructions assume the folder structure as per the Next topic. You're expected to update the folder reference as per your environment.
Also, since you cannot run a Praos node yet, the instructions here-in allow you to join a private haskell testnet network (phtn).  We will gradually update to Praos version and update the phtn references.</p>
<p>*Note that the shelley (Praos) codebase is still being cooked in the oven while we're trying to taste it, expect hand burns if not careful
Since we're just trying to keep up with codebase, expect rapid changes (some breaking, requiring redo of network - but that's always the intent of keeping up with bleeding tech). Feedback/Contribution and ownership of tasks is always welcome.</p>
<h3><a class="header" href="#cardano-node-tools" id="cardano-node-tools">Cardano Node Tools</a></h3>
<p>This is a multi-purpose script to operate various activities (like creating keys, transactions, registering stake pool , delegating to a pool or updating binaries) using cardano node.</p>
<p>The script assumes the <a href="Appendix/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> have already been run.</p>
<h4><a class="header" href="#download-setup_monsh" id="download-setup_monsh">Download setup_mon.sh</a></h4>
<p>If you have run <code>prereqs.sh</code>, this should already be available in your scripts folder. To download cntools.sh you can execute the commands below:</p>
<pre><code class="language-bash">cd $CNODE_HOME/scripts
wget https://raw.githubusercontent.com/cardano-community/guild-operators/master/scripts/cnode-helper-scripts/setup_mon.sh
chmod 750 setup_mon.sh
</code></pre>
<h4><a class="header" href="#set-up-monitoring" id="set-up-monitoring">Set up Monitoring</a></h4>
<p>Execute setup_mon.sh with full path to destination folder you want to setup monitoring in</p>
<pre><code class="language-bash">./setup_mon.sh $CNODE_HOME/monitoring
#
# Please use hasPrometeus's IP:PORT from node's config file.
# The files will be installed in the &quot;$CNODE_HOME/monitoring&quot; directory.
# What port will be used for prometheus web server (Default is 9090)?9003
# What is the ip of the node (default:127.0.0.1)?
# What port is used for prometheus metrics of the node running on 127.0.0.1's (Default is 9001)?
# Is this correct? http://127.0.0.1:9001/metrics
# Do you want to continue? [Y/n/q] Y
# 
# Downloading prometheus v2.18.1...
# Downloading grafana v7.0.0...
# Downloading exporter v0.18.1...
# Downloading grafana dashboard(s)...
#   - Haskel_Node_SKY_Relay1_Dash.json
#   - cardano-application-dashboard-v2.json
# 
# Configuring components
# 
# 
# =====================================================
# Installation is completed
# =====================================================
# 
# - Prometheus (default): http://localhost:9003/metrics
#     Node metrics:       http://127.0.0.1:9001
#     Node exp metrics:   http://127.0.0.1:9002
# - Grafana (default):    http://localhost:3000
# 
# 
# You need to do the following to configure grafana:
# 0. Start the required services in a new terminal by &quot;$CNODE_HOME/monitoring/start_all.sh&quot;
#   - check the prometheus and its exporters by opening URLs above after start.
# 1. Login to grafana as admin/admin (http://localhost:3000)
# 2. Add &quot;prometheus&quot; (all lowercase) datasource (http://localhost:9003)
# 3. Create a new dashboard by importing dashboards (left plus sign).
#   - Sometimes, the individual panel's &quot;prometheus&quot; datasource needs to be refreshed.
# 
# Enjoy...
# 
# Cleaning up...
</code></pre>
<h3><a class="header" href="#sample-postgres-deployment-instructions" id="sample-postgres-deployment-instructions">Sample Postgres Deployment instructions</a></h3>
<p>These deployment instructions used for reference while building <a href="Appendix/dbsync.html">cardano-db-sync</a> tool. These are just for reference and ease of set up and consistency for those who are new to Postgres DB.
It is recommended to customise these as per your needs for Production builds.</p>
<h4><a class="header" href="#install-postgresql-server" id="install-postgresql-server">Install PostgreSQL Server</a></h4>
<p>Execute commands below to set up Postgres Server</p>
<pre><code class="language-bash"># Determine OS platform
OS_ID=$(grep -i ^id_like= /etc/os-release | cut -d= -f 2)
DISTRO=$(grep -i ^NAME= /etc/os-release | cut -d= -f 2)

if [ -z &quot;${OS_ID##*debian*}&quot; ]; then
  #Debian/Ubuntu
  wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
  RELEASE=$(lsb_release -cs)
  echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ ${RELEASE}&quot;-pgdg main | sudo tee  /etc/apt/sources.list.d/pgdg.list
  sudo apt-get update
  sudo apt-get -y install postgresql-11 postgresql-server-dev-11 postgresql-contrib libghc-hdbc-postgresql-dev
  sudo sed -i &quot;s#  ident#  md5#g&quot; /etc/postgresql/11/main/pg_hba.conf
  sudo systemctl restart postgresql
  sudo systemctl enable postgresql
elif [ -z &quot;${OS_ID##*rhel*}&quot; ]; then
  #CentOS/RHEL/Fedora
  sudo yum install -y postgresql-server postgresql-server-devel postgresql-contrib postgresql-devel libpq-devel
  sudo postgresql-setup initdb
  sudo sed -i &quot;s#  ident#  md5#g&quot; /var/lib/pgsql/data/pg_hba.conf
  sudo systemctl start postgresql
  sudo systemctl enable postgresql
else
  echo &quot;We have no automated procedures for this ${DISTRO} system&quot;
fi
</code></pre>
<h4><a class="header" href="#create-user-in-postgres" id="create-user-in-postgres">Create User in Postgres</a></h4>
<p>Login to Postgres instance as superuser:</p>
<pre><code class="language-bash">echo $(whoami)
# &lt;user&gt;
sudo su postgres
psql
</code></pre>
<p>Note the <user> returned as the output of <code>echo $(whoami)</code> command. Replace all instance of <user> in the documentation below.
Execute the below in psql prompt. Replace <strong><username></strong> and <strong>PasswordYouWant</strong> with your OS user (output of <code>echo $(whoami)</code> command executed above) and a password you'd like to authenticate to Postgres with:</p>
<pre><code class="language-sql">CREATE ROLE &lt;user&gt; SUPERUSER LOGIN;
ALTER USER &lt;user&gt; PASSWORD 'PasswordYouWant';
\q
</code></pre>
<p>Type <code>exit</code> at shell to return to your user from postgres</p>
<h4><a class="header" href="#verify-login-to-postgres-instance" id="verify-login-to-postgres-instance">Verify Login to postgres instance</a></h4>
<pre><code class="language-bash">export PGPASSFILE=$CNODE_HOME/priv/.pgpass
echo &quot;localhost:5432:cexplorer_phtn:$(whoami):PasswordYouWant&quot; &gt; $PGPASSFILE
chmod 0600 $PGPASSFILE
psql postgres
# psql (10.6)
# Type &quot;help&quot; for help.
# 
# postgres=#
</code></pre>
<h3><a class="header" href="#starting-as-a-bft-member-node-defined-in-genesis-of-tpraos" id="starting-as-a-bft-member-node-defined-in-genesis-of-tpraos">Starting as a BFT member node defined in Genesis of TPraos</a></h3>
<p>Use this guide only if you already have your genesis keys (referred to as <code>delegate.skey</code> below). The step may not apply to most of the pool operators.
Ensure the <a href="Appendix/../Common.html#dependencies-and-folder-structure-setup">Pre-Requisites</a> are in place before you proceed.</p>
<h4><a class="header" href="#create-verification-key" id="create-verification-key">Create verification key</a></h4>
<pre><code class="language-bash"># Create the Node operation keys
cardano-cli shelley node key-gen-VRF --verification-key-file $CNODE_HOME/priv/vrf.vkey --signing-key-file $CNODE_HOME/priv/vrf.skey
cardano-cli shelley node key-gen-KES --verification-key-file $CNODE_HOME/priv/kes.vkey --signing-key-file $CNODE_HOME/priv/kes.skey
cardano-cli shelley node issue-op-cert --kes-verification-key-file $CNODE_HOME/priv/kes.vkey --cold-signing-key-file $CNODE_HOME/priv/delegate.skey --operational-certificate-issue-counter $CNODE_HOME/priv/delegate.counter --kes-period 0 --out-file $CNODE_HOME/priv/ops.cert 
</code></pre>
<h4><a class="header" href="#start-node" id="start-node">Start Node</a></h4>
<pre><code class="language-bash"># Run the node
cd $CNODE_HOME/scripts
./cnode.sh
</code></pre>
<h3><a class="header" href="#contributors" id="contributors">Contributors</a></h3>
<p>Everyone is welcome to contribute to the guide, as well as the repository. Below is just a thank you to people who have been contributing consistently:</p>
<p><a href="https://github.com/gufmar">Markus</a><br />
<a href="https://github.com/ilap">Pal Dorogi</a><br />
<a href="https://github.com/oldcryptogeek">OCG</a><br />
<a href="https://github.com/RedOracle">RedOracle</a><br />
<a href="https://github.com/papacarp">Papacarp</a><br />
<a href="https://github.com/bergr01">Bergr01</a><br />
<a href="https://github.com/Scitz0">Ola Ahlman</a><br />
<a href="https://github.com/rdlrt">Priyank</a><br />
<a href="https://github.com/psychomb">Psychomb</a><br />
<a href="https://github.com/PegasusPool">PegasusPool</a><br />
<a href="https://github.com/matthijs-aeon">Matthijs</a><br />
<a href="https://github.com/mmahut">Marek</a></p>
<p><strong>Hopefully we have more joining the list soon :) To start contributing, simply hit the <a href="https://github.com/cardano-community/guild-operators">github repository</a> and raise Issue/Pull Request</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
